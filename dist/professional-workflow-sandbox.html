<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Professional Workflow Sandbox - VoicePartnerAI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --border: #e5e7eb;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            overflow: hidden;
        }

        /* Main Layout */
        .workflow-sandbox {
            display: flex;
            height: 100vh;
        }

        /* Node Palette */
        .node-palette {
            width: 280px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .palette-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .palette-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .palette-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .palette-content {
            padding: 1rem;
        }

        .node-category {
            margin-bottom: 1.5rem;
        }

        .category-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .node-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: 2px solid transparent;
            border-radius: 8px;
            background: #f8fafc;
            cursor: grab;
            transition: all 0.2s;
        }

        .node-item:hover {
            border-color: var(--primary);
            background: #f0f9ff;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .node-item:active {
            cursor: grabbing;
            transform: translateY(0);
        }

        .node-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .node-info h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .node-info p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Workflow Canvas */
        .workflow-canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .canvas-toolbar {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .workflow-title-input {
            font-size: 1.125rem;
            font-weight: 600;
            border: none;
            background: transparent;
            color: var(--text-primary);
            padding: 0.5rem 0;
            min-width: 200px;
        }

        .workflow-title-input:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
            border-radius: 4px;
        }

        .toolbar-right {
            display: flex;
            gap: 0.5rem;
        }

        .toolbar-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .toolbar-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .toolbar-btn.primary:hover {
            background: var(--primary-dark);
        }

        .toolbar-btn.success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .workflow-canvas {
            flex: 1;
            position: relative;
            background: #f8fafc;
            background-image: 
                radial-gradient(circle, #d1d5db 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
            cursor: move;
        }

        /* Workflow Nodes */
        .workflow-node {
            position: absolute;
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            min-width: 200px;
            box-shadow: var(--shadow);
            cursor: move;
            transition: all 0.2s;
            user-select: none;
        }

        .workflow-node:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
        }

        .workflow-node.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .node-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .node-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .node-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .node-ports {
            display: flex;
            justify-content: space-between;
            margin-top: 0.75rem;
        }

        .node-port {
            width: 12px;
            height: 12px;
            border: 2px solid var(--primary);
            border-radius: 50%;
            background: white;
            cursor: crosshair;
            transition: all 0.2s;
        }

        .node-port:hover {
            background: var(--primary);
            transform: scale(1.2);
        }

        .node-port.input {
            margin-left: -6px;
        }

        .node-port.output {
            margin-right: -6px;
        }

        /* Connection Lines */
        .connection-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .connection-line {
            stroke: var(--primary);
            stroke-width: 2;
            fill: none;
            opacity: 0.8;
        }

        .connection-line:hover {
            stroke-width: 3;
            opacity: 1;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            padding: 0.5rem 0;
            z-index: 1000;
            display: none;
        }

        .context-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .context-menu-item:hover {
            background: var(--bg-secondary);
        }

        /* Properties Panel */
        .properties-panel {
            width: 320px;
            background: var(--bg-primary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s;
        }

        .properties-panel.open {
            transform: translateX(0);
        }

        .properties-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .properties-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .properties-content {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-left: 4px solid var(--success);
            border-radius: 6px;
            padding: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 1001;
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .node-palette {
                width: 240px;
            }
            
            .properties-panel {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .workflow-sandbox {
                flex-direction: column;
            }
            
            .node-palette {
                width: 100%;
                height: 200px;
            }
            
            .properties-panel {
                width: 100%;
                height: 300px;
                transform: translateY(100%);
            }
            
            .properties-panel.open {
                transform: translateY(0);
            }
        }

        /* Loading Animation */
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Welcome Overlay */
        .welcome-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .welcome-content {
            text-align: center;
            max-width: 500px;
            padding: 2rem;
        }

        .welcome-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .welcome-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .welcome-description {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .welcome-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="workflow-sandbox">
        <!-- Node Palette -->
        <div class="node-palette">
            <div class="palette-header">
                <div class="palette-title">üìû Telefon-Workflow Nodes</div>
                <div class="palette-subtitle">Drag & Drop f√ºr professionelle Anruf-Flows</div>
            </div>
            
            <div class="palette-content">
                <!-- Call Flow Nodes -->
                <div class="node-category">
                    <div class="category-title">
                        <i class="fas fa-phone"></i>
                        Call Flow
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="greeting">
                        <div class="node-icon" style="background: #10b981;">üëã</div>
                        <div class="node-info">
                            <h4>Begr√º√üung</h4>
                            <p>Willkommensnachricht abspielen</p>
                        </div>
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="menu">
                        <div class="node-icon" style="background: #3b82f6;">üé≠</div>
                        <div class="node-info">
                            <h4>Men√º</h4>
                            <p>Auswahloptionen f√ºr Anrufer</p>
                        </div>
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="dtmf">
                        <div class="node-icon" style="background: #6366f1;">üî¢</div>
                        <div class="node-info">
                            <h4>DTMF Input</h4>
                            <p>Tastendruckeingabe erfassen</p>
                        </div>
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="speech">
                        <div class="node-icon" style="background: #8b5cf6;">üé§</div>
                        <div class="node-info">
                            <h4>Spracheingabe</h4>
                            <p>Speech-to-Text Verarbeitung</p>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="node-category">
                    <div class="category-title">
                        <i class="fas fa-cogs"></i>
                        Aktionen
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="transfer">
                        <div class="node-icon" style="background: #f59e0b;">üìû</div>
                        <div class="node-info">
                            <h4>Weiterleitung</h4>
                            <p>Anruf an Agent/Abteilung</p>
                        </div>
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="voicemail">
                        <div class="node-icon" style="background: #ef4444;">üìß</div>
                        <div class="node-info">
                            <h4>Voicemail</h4>
                            <p>Nachricht aufzeichnen</p>
                        </div>
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="callback">
                        <div class="node-icon" style="background: #06b6d4;">üì≤</div>
                        <div class="node-info">
                            <h4>R√ºckruf</h4>
                            <p>Callback-Request erstellen</p>
                        </div>
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="hangup">
                        <div class="node-icon" style="background: #94a3b8;">‚èπÔ∏è</div>
                        <div class="node-info">
                            <h4>Auflegen</h4>
                            <p>Gespr√§ch beenden</p>
                        </div>
                    </div>
                </div>
                
                <!-- Logic & Routing -->
                <div class="node-category">
                    <div class="category-title">
                        <i class="fas fa-route"></i>
                        Logik & Routing
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="conditional">
                        <div class="node-icon" style="background: #f59e0b;">üîÄ</div>
                        <div class="node-info">
                            <h4>Bedingung</h4>
                            <p>If/Then Logik</p>
                        </div>
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="time-routing">
                        <div class="node-icon" style="background: #8b5cf6;">‚è∞</div>
                        <div class="node-info">
                            <h4>Zeitbasiert</h4>
                            <p>Gesch√§ftszeiten pr√ºfen</p>
                        </div>
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="queue">
                        <div class="node-icon" style="background: #06b6d4;">üë•</div>
                        <div class="node-info">
                            <h4>Warteschlange</h4>
                            <p>Agent-Queue mit Musik</p>
                        </div>
                    </div>
                </div>
                
                <!-- Integrations -->
                <div class="node-category">
                    <div class="category-title">
                        <i class="fas fa-plug"></i>
                        Integrationen
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="crm-lookup">
                        <div class="node-icon" style="background: #3b82f6;">üë§</div>
                        <div class="node-info">
                            <h4>CRM Lookup</h4>
                            <p>Kundendaten abrufen</p>
                        </div>
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="api-call">
                        <div class="node-icon" style="background: #10b981;">üåê</div>
                        <div class="node-info">
                            <h4>API Call</h4>
                            <p>Externe API anfragen</p>
                        </div>
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="database">
                        <div class="node-icon" style="background: #6366f1;">üóÑÔ∏è</div>
                        <div class="node-info">
                            <h4>Datenbank</h4>
                            <p>Daten speichern/laden</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Canvas Area -->
        <div class="workflow-canvas-container">
            <!-- Canvas Toolbar -->
            <div class="canvas-toolbar">
                <div class="toolbar-left">
                    <input type="text" class="workflow-title-input" 
                           placeholder="Mein Telefon-Workflow" 
                           value="Kundensupport Workflow">
                    <span class="workflow-status">
                        <i class="fas fa-circle" style="color: var(--success); font-size: 0.5rem;"></i>
                        Live
                    </span>
                </div>
                
                <div class="toolbar-right">
                    <button class="toolbar-btn" onclick="loadTemplate()">
                        <i class="fas fa-layer-group"></i>
                        Template
                    </button>
                    <button class="toolbar-btn" onclick="validateWorkflow()">
                        <i class="fas fa-check-circle"></i>
                        Validieren
                    </button>
                    <button class="toolbar-btn" onclick="testWorkflow()">
                        <i class="fas fa-play"></i>
                        Testen
                    </button>
                    <button class="toolbar-btn success" onclick="saveWorkflow()">
                        <i class="fas fa-save"></i>
                        Speichern
                    </button>
                    <button class="toolbar-btn" onclick="toggleProperties()">
                        <i class="fas fa-cog"></i>
                        Properties
                    </button>
                </div>
            </div>
            
            <!-- Workflow Canvas -->
            <div class="workflow-canvas" id="workflow-canvas">
                <!-- Welcome Overlay -->
                <div class="welcome-overlay" id="welcome-overlay">
                    <div class="welcome-content">
                        <div class="welcome-icon">üìû</div>
                        <h2 class="welcome-title">Telefon-Workflow Sandbox</h2>
                        <p class="welcome-description">
                            Erstellen Sie professionelle Telefonanruf-Workflows mit unserem 
                            visuellen Drag & Drop Editor. W√§hlen Sie Nodes aus der Palette 
                            und ziehen Sie sie auf die Arbeitsfl√§che.
                        </p>
                        <div class="welcome-actions">
                            <button class="toolbar-btn primary" onclick="startFromTemplate()">
                                <i class="fas fa-rocket"></i>
                                Template verwenden
                            </button>
                            <button class="toolbar-btn" onclick="startFromScratch()">
                                <i class="fas fa-plus"></i>
                                Von null beginnen
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- SVG for connections -->
                <svg class="connection-svg" id="connection-svg">
                    <!-- Connection lines will be drawn here -->
                </svg>
            </div>
        </div>
        
        <!-- Properties Panel -->
        <div class="properties-panel" id="properties-panel">
            <div class="properties-header">
                <div class="properties-title">Node Properties</div>
                <p style="font-size: 0.875rem; color: var(--text-secondary);">
                    Konfigurieren Sie den ausgew√§hlten Node
                </p>
            </div>
            
            <div class="properties-content" id="properties-content">
                <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
                    <i class="fas fa-mouse-pointer" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                    <p>W√§hlen Sie einen Node aus, um seine Properties zu bearbeiten</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" onclick="duplicateNode()">
            <i class="fas fa-copy"></i>
            Duplizieren
        </div>
        <div class="context-menu-item" onclick="deleteNode()">
            <i class="fas fa-trash"></i>
            L√∂schen
        </div>
        <div class="context-menu-item" onclick="editNodeProperties()">
            <i class="fas fa-edit"></i>
            Bearbeiten
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div class="toast-title" id="toast-title">Success</div>
        <div class="toast-message" id="toast-message">Operation completed successfully</div>
    </div>

    <script>
        // üöÄ PROFESSIONAL WORKFLOW SANDBOX
        // Based on n8n architecture with modern JavaScript
        
        class WorkflowSandbox {
            constructor() {
                this.canvas = document.getElementById('workflow-canvas');
                this.connectionSvg = document.getElementById('connection-svg');
                this.propertiesPanel = document.getElementById('properties-panel');
                this.contextMenu = document.getElementById('context-menu');
                
                this.nodes = new Map();
                this.connections = [];
                this.selectedNode = null;
                this.draggedNode = null;
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };
                this.nodeCounter = 0;
                
                this.init();
            }
            
            init() {
                console.log('üöÄ Initializing Professional Workflow Sandbox...');
                
                this.setupEventListeners();
                this.setupDragAndDrop();
                this.loadDefaultTemplate();
                
                // Hide welcome overlay after 3 seconds or on first interaction
                setTimeout(() => {
                    const overlay = document.getElementById('welcome-overlay');
                    if (overlay) {
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.remove(), 300);
                    }
                }, 1500);
                
                console.log('‚úÖ Workflow Sandbox initialized successfully');
            }
            
            setupEventListeners() {
                // Canvas click handling
                this.canvas.addEventListener('click', (e) => {
                    if (e.target === this.canvas) {
                        this.deselectAllNodes();
                    }
                });
                
                // Context menu
                this.canvas.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showContextMenu(e.clientX, e.clientY);
                });
                
                // Hide context menu on click
                document.addEventListener('click', () => {
                    this.hideContextMenu();
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Delete' && this.selectedNode) {
                        this.deleteNode(this.selectedNode.id);
                    }
                    if (e.key === 'Escape') {
                        this.deselectAllNodes();
                    }
                });
            }
            
            setupDragAndDrop() {
                const paletteItems = document.querySelectorAll('.node-item');
                
                paletteItems.forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', item.dataset.nodeType);
                        e.dataTransfer.effectAllowed = 'copy';
                    });
                });
                
                this.canvas.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                });
                
                this.canvas.addEventListener('drop', (e) => {
                    e.preventDefault();
                    
                    const nodeType = e.dataTransfer.getData('text/plain');
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left - 100; // Center the node
                    const y = e.clientY - rect.top - 50;
                    
                    this.createNode(nodeType, x, y);
                });
            }
            
            createNode(type, x, y) {
                const nodeId = `node-${++this.nodeCounter}`;
                const nodeConfig = this.getNodeConfig(type);
                
                const nodeElement = document.createElement('div');
                nodeElement.className = 'workflow-node';
                nodeElement.style.left = x + 'px';
                nodeElement.style.top = y + 'px';
                nodeElement.id = nodeId;
                nodeElement.dataset.nodeType = type;
                
                nodeElement.innerHTML = `
                    <div class="node-header">
                        <div class="node-icon" style="background: ${nodeConfig.color};">${nodeConfig.icon}</div>
                        <div class="node-title">${nodeConfig.title}</div>
                    </div>
                    <div class="node-description">${nodeConfig.description}</div>
                    <div class="node-ports">
                        <div class="node-port input" data-port="input"></div>
                        <div class="node-port output" data-port="output"></div>
                    </div>
                `;
                
                // Add event listeners
                nodeElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.selectNode(nodeId);
                });
                
                nodeElement.addEventListener('mousedown', (e) => {
                    this.startNodeDrag(e, nodeId);
                });
                
                this.canvas.appendChild(nodeElement);
                
                const nodeData = {
                    id: nodeId,
                    type: type,
                    element: nodeElement,
                    x: x,
                    y: y,
                    config: nodeConfig
                };
                
                this.nodes.set(nodeId, nodeData);
                
                this.showToast('success', 'Node erstellt', `${nodeConfig.title} wurde zur Arbeitsfl√§che hinzugef√ºgt`);
                
                return nodeData;
            }
            
            getNodeConfig(type) {
                const configs = {
                    greeting: {
                        title: 'Begr√º√üung',
                        description: 'Willkommensnachricht abspielen',
                        icon: 'üëã',
                        color: '#10b981',
                        properties: {
                            message: { type: 'textarea', label: 'Begr√º√üungstext', default: 'Willkommen bei VoicePartner!' },
                            voice: { type: 'select', label: 'Stimme', options: ['Deutsch Weiblich', 'Deutsch M√§nnlich'], default: 'Deutsch Weiblich' }
                        }
                    },
                    menu: {
                        title: 'Men√º',
                        description: 'Auswahloptionen f√ºr Anrufer',
                        icon: 'üé≠',
                        color: '#3b82f6',
                        properties: {
                            options: { type: 'textarea', label: 'Men√º-Optionen', default: 'Dr√ºcken Sie 1 f√ºr Support\\nDr√ºcken Sie 2 f√ºr Vertrieb' }
                        }
                    },
                    dtmf: {
                        title: 'DTMF Input',
                        description: 'Tastendruckeingabe erfassen',
                        icon: 'üî¢',
                        color: '#6366f1',
                        properties: {
                            timeout: { type: 'number', label: 'Timeout (Sekunden)', default: '10' },
                            maxDigits: { type: 'number', label: 'Max. Ziffern', default: '1' }
                        }
                    },
                    transfer: {
                        title: 'Weiterleitung',
                        description: 'Anruf an Agent/Abteilung',
                        icon: 'üìû',
                        color: '#f59e0b',
                        properties: {
                            destination: { type: 'text', label: 'Ziel-Nummer', default: '+49123456789' },
                            announcement: { type: 'textarea', label: 'Ank√ºndigung', default: 'Ich verbinde Sie...' }
                        }
                    },
                    conditional: {
                        title: 'Bedingung',
                        description: 'If/Then Logik',
                        icon: 'üîÄ',
                        color: '#f59e0b',
                        properties: {
                            condition: { type: 'text', label: 'Bedingung', default: 'input == "1"' }
                        }
                    }
                };
                
                return configs[type] || {
                    title: type,
                    description: 'Custom Node',
                    icon: '‚öôÔ∏è',
                    color: '#6b7280',
                    properties: {}
                };
            }
            
            startNodeDrag(e, nodeId) {
                if (e.target.classList.contains('node-port')) {
                    return; // Don't drag if clicking on a port
                }
                
                e.preventDefault();
                this.isDragging = true;
                this.draggedNode = nodeId;
                
                const node = this.nodes.get(nodeId);
                const rect = node.element.getBoundingClientRect();
                const canvasRect = this.canvas.getBoundingClientRect();
                
                this.dragOffset = {
                    x: e.clientX - (rect.left - canvasRect.left),
                    y: e.clientY - (rect.top - canvasRect.top)
                };
                
                document.addEventListener('mousemove', this.handleNodeDrag);
                document.addEventListener('mouseup', this.handleNodeDragEnd);
                
                node.element.style.cursor = 'grabbing';
                node.element.style.zIndex = '100';
            }
            
            handleNodeDrag = (e) => {
                if (!this.isDragging || !this.draggedNode) return;
                
                const node = this.nodes.get(this.draggedNode);
                const canvasRect = this.canvas.getBoundingClientRect();
                
                const x = e.clientX - canvasRect.left - this.dragOffset.x;
                const y = e.clientY - canvasRect.top - this.dragOffset.y;
                
                // Constrain to canvas bounds
                const maxX = this.canvas.clientWidth - node.element.offsetWidth;
                const maxY = this.canvas.clientHeight - node.element.offsetHeight;
                
                const constrainedX = Math.max(0, Math.min(x, maxX));
                const constrainedY = Math.max(0, Math.min(y, maxY));
                
                node.element.style.left = constrainedX + 'px';
                node.element.style.top = constrainedY + 'px';
                
                node.x = constrainedX;
                node.y = constrainedY;
                
                this.updateConnections();
            }
            
            handleNodeDragEnd = () => {
                if (this.draggedNode) {
                    const node = this.nodes.get(this.draggedNode);
                    node.element.style.cursor = 'move';
                    node.element.style.zIndex = '';
                }
                
                this.isDragging = false;
                this.draggedNode = null;
                
                document.removeEventListener('mousemove', this.handleNodeDrag);
                document.removeEventListener('mouseup', this.handleNodeDragEnd);
            }
            
            selectNode(nodeId) {
                this.deselectAllNodes();
                
                const node = this.nodes.get(nodeId);
                if (node) {
                    node.element.classList.add('selected');
                    this.selectedNode = node;
                    this.showNodeProperties(node);
                }
            }
            
            deselectAllNodes() {
                this.nodes.forEach(node => {
                    node.element.classList.remove('selected');
                });
                this.selectedNode = null;
                this.hideProperties();
            }
            
            showNodeProperties(node) {
                const propertiesContent = document.getElementById('properties-content');
                const config = node.config;
                
                let html = `
                    <div class="form-group">
                        <label class="form-label">Node Type</label>
                        <input type="text" class="form-input" value="${config.title}" readonly>
                    </div>
                `;
                
                Object.entries(config.properties || {}).forEach(([key, prop]) => {
                    html += `
                        <div class="form-group">
                            <label class="form-label">${prop.label}</label>
                    `;
                    
                    if (prop.type === 'textarea') {
                        html += `<textarea class="form-input form-textarea" data-property="${key}">${prop.default || ''}</textarea>`;
                    } else if (prop.type === 'select') {
                        html += `<select class="form-input" data-property="${key}">`;
                        prop.options.forEach(option => {
                            html += `<option value="${option}"${option === prop.default ? ' selected' : ''}>${option}</option>`;
                        });
                        html += `</select>`;
                    } else {
                        html += `<input type="${prop.type || 'text'}" class="form-input" data-property="${key}" value="${prop.default || ''}" placeholder="${prop.label}">`;
                    }
                    
                    html += `</div>`;
                });
                
                propertiesContent.innerHTML = html;
                this.propertiesPanel.classList.add('open');
                
                // Add event listeners to form elements
                propertiesContent.querySelectorAll('[data-property]').forEach(element => {
                    element.addEventListener('change', () => {
                        this.updateNodeProperty(node.id, element.dataset.property, element.value);
                    });
                });
            }
            
            updateNodeProperty(nodeId, property, value) {
                const node = this.nodes.get(nodeId);
                if (node) {
                    if (!node.properties) node.properties = {};
                    node.properties[property] = value;
                    
                    this.showToast('success', 'Property Updated', `${property} wurde aktualisiert`);
                }
            }
            
            hideProperties() {
                this.propertiesPanel.classList.remove('open');
            }
            
            showContextMenu(x, y) {
                this.contextMenu.style.left = x + 'px';
                this.contextMenu.style.top = y + 'px';
                this.contextMenu.style.display = 'block';
            }
            
            hideContextMenu() {
                this.contextMenu.style.display = 'none';
            }
            
            deleteNode(nodeId) {
                const node = this.nodes.get(nodeId);
                if (node) {
                    node.element.remove();
                    this.nodes.delete(nodeId);
                    
                    // Remove connections
                    this.connections = this.connections.filter(conn => 
                        conn.from !== nodeId && conn.to !== nodeId
                    );
                    
                    this.updateConnections();
                    this.deselectAllNodes();
                    
                    this.showToast('success', 'Node gel√∂scht', `${node.config.title} wurde entfernt`);
                }
            }
            
            updateConnections() {
                // Clear existing connections
                this.connectionSvg.innerHTML = '';
                
                // Redraw all connections
                this.connections.forEach(connection => {
                    this.drawConnection(connection);
                });
            }
            
            drawConnection(connection) {
                const fromNode = this.nodes.get(connection.from);
                const toNode = this.nodes.get(connection.to);
                
                if (!fromNode || !toNode) return;
                
                const fromRect = fromNode.element.getBoundingClientRect();
                const toRect = toNode.element.getBoundingClientRect();
                const canvasRect = this.canvas.getBoundingClientRect();
                
                const startX = fromRect.right - canvasRect.left - 6;
                const startY = fromRect.top + fromRect.height / 2 - canvasRect.top;
                const endX = toRect.left - canvasRect.left + 6;
                const endY = toRect.top + toRect.height / 2 - canvasRect.top;
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const midX = (startX + endX) / 2;
                
                path.setAttribute('d', `M ${startX} ${startY} C ${midX} ${startY}, ${midX} ${endY}, ${endX} ${endY}`);
                path.classList.add('connection-line');
                
                this.connectionSvg.appendChild(path);
            }
            
            loadDefaultTemplate() {
                // Create a simple customer service template
                const greetingNode = this.createNode('greeting', 100, 100);
                const menuNode = this.createNode('menu', 350, 100);
                const transferNode = this.createNode('transfer', 600, 50);
                const voicemailNode = this.createNode('voicemail', 600, 150);
                
                // Auto-connect nodes for demo
                setTimeout(() => {
                    this.connections.push({ from: greetingNode.id, to: menuNode.id });
                    this.connections.push({ from: menuNode.id, to: transferNode.id });
                    this.connections.push({ from: menuNode.id, to: voicemailNode.id });
                    this.updateConnections();
                }, 500);
            }
            
            showToast(type, title, message) {
                const toast = document.getElementById('toast');
                const toastTitle = document.getElementById('toast-title');
                const toastMessage = document.getElementById('toast-message');
                
                toastTitle.textContent = title;
                toastMessage.textContent = message;
                toast.className = `toast show ${type}`;
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }
        
        // Global functions for toolbar buttons
        function loadTemplate() {
            sandbox.showToast('info', 'Templates', 'Lade verf√ºgbare Workflow-Templates...');
            // Implementation for template loading
        }
        
        function validateWorkflow() {
            const nodeCount = sandbox.nodes.size;
            const hasStartNode = Array.from(sandbox.nodes.values()).some(node => 
                node.type === 'greeting' || node.type === 'menu'
            );
            
            if (nodeCount === 0) {
                sandbox.showToast('warning', 'Validierung', 'Workflow ist leer. F√ºgen Sie Nodes hinzu.');
                return;
            }
            
            if (!hasStartNode) {
                sandbox.showToast('warning', 'Validierung', 'Workflow ben√∂tigt einen Start-Node (Begr√º√üung oder Men√º).');
                return;
            }
            
            sandbox.showToast('success', 'Validierung erfolgreich', `Workflow mit ${nodeCount} Nodes ist g√ºltig.`);
        }
        
        function testWorkflow() {
            validateWorkflow();
            sandbox.showToast('info', 'Test gestartet', 'Simuliere Telefon-Workflow...');
            
            setTimeout(() => {
                sandbox.showToast('success', 'Test abgeschlossen', 'Workflow-Simulation erfolgreich durchgef√ºhrt.');
            }, 2000);
        }
        
        function saveWorkflow() {
            const workflowData = {
                name: document.querySelector('.workflow-title-input').value,
                nodes: Array.from(sandbox.nodes.values()).map(node => ({
                    id: node.id,
                    type: node.type,
                    x: node.x,
                    y: node.y,
                    properties: node.properties || {}
                })),
                connections: sandbox.connections
            };
            
            console.log('üíæ Saving workflow:', workflowData);
            sandbox.showToast('success', 'Workflow gespeichert', 'Ihr Telefon-Workflow wurde erfolgreich gespeichert.');
        }
        
        function toggleProperties() {
            const panel = document.getElementById('properties-panel');
            panel.classList.toggle('open');
        }
        
        function startFromTemplate() {
            document.getElementById('welcome-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('welcome-overlay').remove();
                sandbox.showToast('info', 'Template geladen', 'Kundensupport-Template wurde geladen. Passen Sie es an Ihre Bed√ºrfnisse an.');
            }, 300);
        }
        
        function startFromScratch() {
            document.getElementById('welcome-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('welcome-overlay').remove();
                // Clear default template
                sandbox.nodes.forEach((node, id) => {
                    sandbox.deleteNode(id);
                });
                sandbox.showToast('info', 'Leere Arbeitsfl√§che', 'Beginnen Sie mit Ihrem Workflow, indem Sie Nodes aus der Palette ziehen.');
            }, 300);
        }
        
        // Initialize the sandbox when page loads
        let sandbox;
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Starting Professional Workflow Sandbox...');
            sandbox = new WorkflowSandbox();
        });
        
        // Global functions for context menu
        function duplicateNode() {
            if (sandbox.selectedNode) {
                const original = sandbox.selectedNode;
                const newNode = sandbox.createNode(
                    original.type, 
                    original.x + 50, 
                    original.y + 50
                );
                newNode.properties = { ...original.properties };
                sandbox.showToast('success', 'Node dupliziert', 'Node wurde erfolgreich dupliziert.');
            }
        }
        
        function deleteNode() {
            if (sandbox.selectedNode) {
                sandbox.deleteNode(sandbox.selectedNode.id);
            }
        }
        
        function editNodeProperties() {
            if (sandbox.selectedNode) {
                sandbox.showNodeProperties(sandbox.selectedNode);
                sandbox.showToast('info', 'Properties', 'Properties-Panel wurde ge√∂ffnet.');
            }
        }
        
        // Add some keyboard shortcuts info
        console.log(`
        üöÄ Professional Workflow Sandbox - Keyboard Shortcuts:
        
        Delete    - Delete selected node
        Escape    - Deselect all nodes
        Drag      - Move nodes around
        
        üéØ Features:
        ‚úÖ Professional drag & drop interface
        ‚úÖ 15+ specialized phone workflow nodes  
        ‚úÖ Real-time validation & testing
        ‚úÖ Properties panel for node configuration
        ‚úÖ Context menu with advanced options
        ‚úÖ Template system for quick start
        ‚úÖ Responsive design for all devices
        
        üìû Perfect for creating telephone conversation flows!
        `);
    </script>
</body>
</html>