<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Agent Builder - VoicePartnerAI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #f59e0b;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-light: #9ca3af;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-accent: #f3f4f6;
            --border-color: #e5e7eb;
            --success-color: #10b981;
            --error-color: #ef4444;
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-secondary);
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        /* Top Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            z-index: 1000;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .logo i {
            margin-right: 0.5rem;
            font-size: 1.5rem;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Left Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            margin-top: 60px;
            padding: 1.5rem;
            overflow-y: auto;
        }
        
        .sidebar-section {
            margin-bottom: 2rem;
        }
        
        .sidebar-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-light);
            margin-bottom: 1rem;
            letter-spacing: 0.5px;
        }
        
        .component-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .component-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .component-item:hover {
            border-color: var(--primary-color);
            background: var(--bg-primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .component-item:active {
            cursor: grabbing;
        }
        
        .component-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
        }
        
        .component-icon.trigger { background: #10b981; }
        .component-icon.action { background: #6366f1; }
        .component-icon.condition { background: #f59e0b; }
        .component-icon.integration { background: #8b5cf6; }
        
        .component-details h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .component-details p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Main Canvas */
        .canvas-container {
            flex: 1;
            margin-top: 60px;
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
        }
        
        .canvas {
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle, #ddd 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
            overflow: auto;
        }
        
        .canvas-node {
            position: absolute;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            min-width: 200px;
            cursor: move;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .canvas-node:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .canvas-node.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .canvas-node.start { border-color: #10b981; }
        .canvas-node.action { border-color: #6366f1; }
        .canvas-node.condition { border-color: #f59e0b; }
        .canvas-node.integration { border-color: #8b5cf6; }
        
        .node-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .node-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }
        
        .node-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .node-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .node-content {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .node-connections {
            display: flex;
            justify-content: space-between;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }
        
        .connection-point {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .connection-point:hover {
            background: var(--primary-color);
            transform: scale(1.2);
        }
        
        .connection-point.input {
            margin-left: -6px;
        }
        
        .connection-point.output {
            margin-right: -6px;
        }
        
        /* Right Properties Panel */
        .properties-panel {
            width: 320px;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-color);
            margin-top: 60px;
            padding: 1.5rem;
            overflow-y: auto;
        }
        
        .properties-header {
            margin-bottom: 1.5rem;
        }
        
        .properties-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .properties-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            background: var(--bg-primary);
            cursor: pointer;
        }
        
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
        }
        
        .voice-preview {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .voice-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .waveform {
            height: 40px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 4px;
            opacity: 0.3;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        /* Test Panel */
        .test-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .test-panel.open {
            transform: translateY(0);
        }
        
        .test-panel-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .test-panel-content {
            padding: 1rem;
        }
        
        .phone-simulator {
            background: #1f2937;
            border-radius: 8px;
            padding: 1rem;
            color: white;
            margin-bottom: 1rem;
        }
        
        .call-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .call-transcript {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 0.75rem;
            font-size: 0.8rem;
            line-height: 1.4;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .test-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 340px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            z-index: 999;
        }
        
        .fab:hover {
            transform: scale(1.1);
        }
        
        /* Drop Zone */
        .drop-zone {
            position: absolute;
            inset: 20px;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.02);
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 1.1rem;
            z-index: 10;
        }
        
        .drop-zone.active {
            display: flex;
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
        }
        
        /* Welcome State */
        .welcome-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-light);
        }
        
        .welcome-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .welcome-state h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }
        
        .welcome-state p {
            font-size: 0.9rem;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .properties-panel {
                width: 280px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
                padding: 1rem 0.5rem;
            }
            
            .sidebar-title,
            .component-details {
                display: none;
            }
            
            .component-item {
                justify-content: center;
                padding: 0.75rem 0.5rem;
            }
            
            .properties-panel {
                display: none;
            }
            
            .test-panel {
                width: 280px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <a href="#" class="logo">
                <i class="fas fa-microphone-alt"></i>
                VoicePartnerAI
            </a>
            <div class="breadcrumb">
                <span>Voice Agents</span>
                <i class="fas fa-chevron-right"></i>
                <span id="agent-name">Neuer Agent</span>
            </div>
        </div>
        
        <div class="header-right">
            <button class="btn btn-secondary" onclick="saveAgent()">
                <i class="fas fa-save"></i>
                Speichern
            </button>
            <button class="btn btn-primary" onclick="testAgent()">
                <i class="fas fa-play"></i>
                Testen
            </button>
            <div class="user-avatar" onclick="showUserMenu()">
                M
            </div>
        </div>
    </header>
    
    <div class="app-container">
        <!-- Left Sidebar - Components -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">Trigger</h3>
                <div class="component-list">
                    <div class="component-item" draggable="true" data-type="phone-call">
                        <div class="component-icon trigger">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div class="component-details">
                            <h4>Anruf eingehend</h4>
                            <p>Startet bei eingehenden Anrufen</p>
                        </div>
                    </div>
                    
                    <div class="component-item" draggable="true" data-type="webhook">
                        <div class="component-icon trigger">
                            <i class="fas fa-globe"></i>
                        </div>
                        <div class="component-details">
                            <h4>Webhook</h4>
                            <p>HTTP-Request Trigger</p>
                        </div>
                    </div>
                    
                    <div class="component-item" draggable="true" data-type="schedule">
                        <div class="component-icon trigger">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="component-details">
                            <h4>Zeitplan</h4>
                            <p>Terminbasierte Ausl√∂sung</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3 class="sidebar-title">Aktionen</h3>
                <div class="component-list">
                    <div class="component-item" draggable="true" data-type="speak">
                        <div class="component-icon action">
                            <i class="fas fa-comment"></i>
                        </div>
                        <div class="component-details">
                            <h4>Sprechen</h4>
                            <p>Text zu Sprache ausgeben</p>
                        </div>
                    </div>
                    
                    <div class="component-item" draggable="true" data-type="listen">
                        <div class="component-icon action">
                            <i class="fas fa-microphone"></i>
                        </div>
                        <div class="component-details">
                            <h4>Zuh√∂ren</h4>
                            <p>Spracheingabe erfassen</p>
                        </div>
                    </div>
                    
                    <div class="component-item" draggable="true" data-type="transfer">
                        <div class="component-icon action">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <div class="component-details">
                            <h4>Weiterleiten</h4>
                            <p>Anruf an Mensch weiterleiten</p>
                        </div>
                    </div>
                    
                    <div class="component-item" draggable="true" data-type="hangup">
                        <div class="component-icon action">
                            <i class="fas fa-phone-slash"></i>
                        </div>
                        <div class="component-details">
                            <h4>Auflegen</h4>
                            <p>Gespr√§ch beenden</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3 class="sidebar-title">Logik</h3>
                <div class="component-list">
                    <div class="component-item" draggable="true" data-type="condition">
                        <div class="component-icon condition">
                            <i class="fas fa-code-branch"></i>
                        </div>
                        <div class="component-details">
                            <h4>Bedingung</h4>
                            <p>If/Else Verzweigung</p>
                        </div>
                    </div>
                    
                    <div class="component-item" draggable="true" data-type="loop">
                        <div class="component-icon condition">
                            <i class="fas fa-sync"></i>
                        </div>
                        <div class="component-details">
                            <h4>Schleife</h4>
                            <p>Aktionen wiederholen</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3 class="sidebar-title">Integrationen</h3>
                <div class="component-list">
                    <div class="component-item" draggable="true" data-type="database">
                        <div class="component-icon integration">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="component-details">
                            <h4>Datenbank</h4>
                            <p>Daten abfragen/speichern</p>
                        </div>
                    </div>
                    
                    <div class="component-item" draggable="true" data-type="email">
                        <div class="component-icon integration">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="component-details">
                            <h4>E-Mail</h4>
                            <p>E-Mails versenden</p>
                        </div>
                    </div>
                    
                    <div class="component-item" draggable="true" data-type="api">
                        <div class="component-icon integration">
                            <i class="fas fa-plug"></i>
                        </div>
                        <div class="component-details">
                            <h4>API Aufruf</h4>
                            <p>Externe Services nutzen</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Canvas -->
        <main class="canvas-container">
            <div class="canvas" id="canvas">
                <div class="drop-zone" id="drop-zone">
                    <div>
                        <i class="fas fa-plus-circle"></i>
                        <div>Komponente hier ablegen</div>
                    </div>
                </div>
                
                <div class="welcome-state" id="welcome-state">
                    <i class="fas fa-robot"></i>
                    <h3>Erstelle deinen Voice Agent</h3>
                    <p>Ziehe Komponenten aus der Seitenleiste, um zu beginnen</p>
                </div>
            </div>
        </main>
        
        <!-- Right Properties Panel -->
        <aside class="properties-panel">
            <div class="properties-header">
                <h3 class="properties-title" id="prop-title">Agent Einstellungen</h3>
                <p class="properties-subtitle" id="prop-subtitle">Grundkonfiguration f√ºr deinen Voice Agent</p>
            </div>
            
            <div id="properties-content">
                <!-- Agent General Settings -->
                <div class="form-group">
                    <label class="form-label">Agent Name</label>
                    <input type="text" class="form-input" id="agent-name-input" placeholder="Mein Voice Agent" value="Kundenservice Bot">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <textarea class="form-textarea" placeholder="Was macht dieser Agent?">Ein intelligenter Kundenservice-Agent f√ºr eingehende Anrufe</textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sprache</label>
                    <select class="form-select">
                        <option>Deutsch (Deutschland)</option>
                        <option>Englisch (US)</option>
                        <option>Franz√∂sisch</option>
                        <option>Spanisch</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Stimme</label>
                    <select class="form-select" id="voice-select" onchange="updateVoicePreview()">
                        <option value="sarah">Sarah (Weiblich, Freundlich)</option>
                        <option value="marcus">Marcus (M√§nnlich, Professionell)</option>
                        <option value="anna">Anna (Weiblich, Energisch)</option>
                        <option value="thomas">Thomas (M√§nnlich, Ruhig)</option>
                    </select>
                    
                    <div class="voice-preview">
                        <div class="voice-controls">
                            <button class="play-btn" onclick="playVoicePreview()">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="waveform">
                                Klicke zum Abspielen
                            </div>
                        </div>
                        <p style="font-size: 0.8rem; color: var(--text-secondary);">
                            "Hallo, ich bin Ihr pers√∂nlicher Assistent. Wie kann ich Ihnen helfen?"
                        </p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Pers√∂nlichkeit</label>
                    <select class="form-select">
                        <option>Freundlich & Hilfsbereit</option>
                        <option>Professionell & Sachlich</option>
                        <option>Entspannt & Locker</option>
                        <option>Energisch & Motivierend</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Maximale Gespr√§chsdauer</label>
                    <select class="form-select">
                        <option>5 Minuten</option>
                        <option>10 Minuten</option>
                        <option>15 Minuten</option>
                        <option>Unbegrenzt</option>
                    </select>
                </div>
            </div>
        </aside>
    </div>
    
    <!-- Test Panel -->
    <div class="test-panel" id="test-panel">
        <div class="test-panel-header">
            <h4>Live Test</h4>
            <button onclick="closeTestPanel()" style="background: none; border: none; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="test-panel-content">
            <div class="phone-simulator">
                <div class="call-status">
                    <div class="status-indicator"></div>
                    <span>Anruf aktiv - 00:47</span>
                </div>
                <div class="call-transcript" id="transcript">
                    <div><strong>Agent:</strong> Hallo, ich bin Ihr Kundenservice-Assistent. Wie kann ich Ihnen helfen?</div>
                    <div><strong>Kunde:</strong> Ich habe ein Problem mit meiner Bestellung...</div>
                    <div><strong>Agent:</strong> Das tut mir leid zu h√∂ren. K√∂nnen Sie mir Ihre Bestellnummer nennen?</div>
                </div>
            </div>
            <div class="test-controls">
                <button class="btn btn-secondary" onclick="endCall()">
                    <i class="fas fa-phone-slash"></i>
                    Auflegen
                </button>
                <button class="btn btn-primary" onclick="startNewCall()">
                    <i class="fas fa-phone"></i>
                    Neuer Test
                </button>
            </div>
        </div>
    </div>
    
    <!-- Floating Action Button -->
    <button class="fab" onclick="openTestPanel()" title="Agent testen">
        <i class="fas fa-phone"></i>
    </button>
    
    <script>
        // Global State
        let selectedNode = null;
        let nodeCounter = 0;
        let nodes = [];
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
            setupCanvas();
            updateAgentName();
        });
        
        // Drag and Drop Setup
        function setupDragAndDrop() {
            const components = document.querySelectorAll('.component-item');
            const canvas = document.getElementById('canvas');
            const dropZone = document.getElementById('drop-zone');
            
            components.forEach(component => {
                component.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.type);
                    this.style.opacity = '0.5';
                });
                
                component.addEventListener('dragend', function(e) {
                    this.style.opacity = '1';
                });
            });
            
            canvas.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('active');
            });
            
            canvas.addEventListener('dragleave', function(e) {
                if (!canvas.contains(e.relatedTarget)) {
                    dropZone.classList.remove('active');
                }
            });
            
            canvas.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('active');
                
                const componentType = e.dataTransfer.getData('text/plain');
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left - 100; // Center the node
                const y = e.clientY - rect.top - 80;
                
                createNode(componentType, x, y);
            });
        }
        
        // Canvas Setup
        function setupCanvas() {
            const canvas = document.getElementById('canvas');
            
            canvas.addEventListener('click', function(e) {
                if (e.target === canvas) {
                    deselectAllNodes();
                    showAgentProperties();
                }
            });
        }
        
        // Create Node
        function createNode(type, x, y) {
            const nodeConfig = getNodeConfig(type);
            const nodeId = `node-${++nodeCounter}`;
            
            const node = {
                id: nodeId,
                type: type,
                title: nodeConfig.title,
                description: nodeConfig.description,
                icon: nodeConfig.icon,
                color: nodeConfig.color,
                x: Math.max(0, x),
                y: Math.max(0, y),
                properties: nodeConfig.properties || {}
            };
            
            nodes.push(node);
            renderNode(node);
            hideWelcomeState();
            selectNode(nodeId);
        }
        
        // Node Configuration
        function getNodeConfig(type) {
            const configs = {
                'phone-call': {
                    title: 'Anruf eingehend',
                    description: 'Startet bei eingehenden Anrufen',
                    icon: 'fas fa-phone',
                    color: 'start',
                    properties: {
                        phoneNumber: '+49 30 12345678',
                        greeting: 'Willkommen bei unserem Service'
                    }
                },
                'speak': {
                    title: 'Sprechen',
                    description: 'Text zu Sprache ausgeben',
                    icon: 'fas fa-comment',
                    color: 'action',
                    properties: {
                        text: 'Hallo, wie kann ich Ihnen helfen?',
                        voice: 'sarah',
                        speed: 'normal'
                    }
                },
                'listen': {
                    title: 'Zuh√∂ren',
                    description: 'Spracheingabe erfassen',
                    icon: 'fas fa-microphone',
                    color: 'action',
                    properties: {
                        timeout: 5,
                        expectedInputs: ['ja', 'nein', 'hilfe']
                    }
                },
                'condition': {
                    title: 'Bedingung',
                    description: 'If/Else Verzweigung',
                    icon: 'fas fa-code-branch',
                    color: 'condition',
                    properties: {
                        condition: 'input == "hilfe"',
                        trueAction: 'Hilfe anzeigen',
                        falseAction: 'Weiter'
                    }
                },
                'transfer': {
                    title: 'Weiterleiten',
                    description: 'An Mitarbeiter weiterleiten',
                    icon: 'fas fa-phone-alt',
                    color: 'action',
                    properties: {
                        department: 'Kundenservice',
                        message: 'Ich verbinde Sie mit einem Mitarbeiter'
                    }
                },
                'hangup': {
                    title: 'Auflegen',
                    description: 'Gespr√§ch beenden',
                    icon: 'fas fa-phone-slash',
                    color: 'action',
                    properties: {
                        message: 'Vielen Dank f√ºr Ihren Anruf. Auf Wiederh√∂ren!'
                    }
                }
            };
            
            return configs[type] || {
                title: 'Unbekannt',
                description: 'Unbekannte Komponente',
                icon: 'fas fa-question',
                color: 'action'
            };
        }
        
        // Render Node
        function renderNode(node) {
            const canvas = document.getElementById('canvas');
            
            const nodeElement = document.createElement('div');
            nodeElement.className = `canvas-node ${node.color}`;
            nodeElement.id = node.id;
            nodeElement.style.left = node.x + 'px';
            nodeElement.style.top = node.y + 'px';
            
            nodeElement.innerHTML = `
                <div class="node-header">
                    <div class="node-icon ${node.color}">
                        <i class="${node.icon}"></i>
                    </div>
                    <div>
                        <div class="node-title">${node.title}</div>
                        <div class="node-description">${node.description}</div>
                    </div>
                </div>
                <div class="node-content">
                    ${getNodeContentPreview(node)}
                </div>
                <div class="node-connections">
                    <div class="connection-point input"></div>
                    <div class="connection-point output"></div>
                </div>
            `;
            
            // Add event listeners
            nodeElement.addEventListener('click', function(e) {
                e.stopPropagation();
                selectNode(node.id);
            });
            
            nodeElement.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('connection-point')) return;
                startNodeDrag(e, node.id);
            });
            
            canvas.appendChild(nodeElement);
        }
        
        // Get Node Content Preview
        function getNodeContentPreview(node) {
            switch(node.type) {
                case 'phone-call':
                    return `üìû ${node.properties.phoneNumber}`;
                case 'speak':
                    return `üí¨ "${node.properties.text.substring(0, 30)}..."`;
                case 'listen':
                    return `üé§ Timeout: ${node.properties.timeout}s`;
                case 'condition':
                    return `üîÄ ${node.properties.condition}`;
                case 'transfer':
                    return `üìû ‚Üí ${node.properties.department}`;
                case 'hangup':
                    return `üìû ‚ùå Gespr√§ch beenden`;
                default:
                    return 'Konfiguration erforderlich';
            }
        }
        
        // Node Selection
        function selectNode(nodeId) {
            deselectAllNodes();
            
            const nodeElement = document.getElementById(nodeId);
            if (nodeElement) {
                nodeElement.classList.add('selected');
                selectedNode = nodes.find(n => n.id === nodeId);
                showNodeProperties(selectedNode);
            }
        }
        
        function deselectAllNodes() {
            document.querySelectorAll('.canvas-node').forEach(node => {
                node.classList.remove('selected');
            });
            selectedNode = null;
        }
        
        // Node Dragging
        function startNodeDrag(e, nodeId) {
            const nodeElement = document.getElementById(nodeId);
            const rect = nodeElement.getBoundingClientRect();
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            isDragging = true;
            
            document.addEventListener('mousemove', dragNode);
            document.addEventListener('mouseup', stopNodeDrag);
            
            nodeElement.style.zIndex = '1000';
        }
        
        function dragNode(e) {
            if (!isDragging || !selectedNode) return;
            
            const canvas = document.getElementById('canvas');
            const canvasRect = canvas.getBoundingClientRect();
            
            const x = e.clientX - canvasRect.left - dragOffset.x;
            const y = e.clientY - canvasRect.top - dragOffset.y;
            
            selectedNode.x = Math.max(0, x);
            selectedNode.y = Math.max(0, y);
            
            const nodeElement = document.getElementById(selectedNode.id);
            nodeElement.style.left = selectedNode.x + 'px';
            nodeElement.style.top = selectedNode.y + 'px';
        }
        
        function stopNodeDrag() {
            isDragging = false;
            document.removeEventListener('mousemove', dragNode);
            document.removeEventListener('mouseup', stopNodeDrag);
            
            if (selectedNode) {
                const nodeElement = document.getElementById(selectedNode.id);
                nodeElement.style.zIndex = '';
            }
        }
        
        // Properties Panel
        function showAgentProperties() {
            document.getElementById('prop-title').textContent = 'Agent Einstellungen';
            document.getElementById('prop-subtitle').textContent = 'Grundkonfiguration f√ºr deinen Voice Agent';
            
            // Show default agent properties (already in HTML)
        }
        
        function showNodeProperties(node) {
            document.getElementById('prop-title').textContent = node.title;
            document.getElementById('prop-subtitle').textContent = node.description;
            
            const content = document.getElementById('properties-content');
            content.innerHTML = getNodePropertiesHTML(node);
        }
        
        function getNodePropertiesHTML(node) {
            let html = '';
            
            switch(node.type) {
                case 'speak':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Text</label>
                            <textarea class="form-textarea" placeholder="Was soll gesagt werden?">${node.properties.text}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Stimme</label>
                            <select class="form-select">
                                <option>Sarah (Weiblich, Freundlich)</option>
                                <option>Marcus (M√§nnlich, Professionell)</option>
                                <option>Anna (Weiblich, Energisch)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Geschwindigkeit</label>
                            <select class="form-select">
                                <option>Langsam</option>
                                <option selected>Normal</option>
                                <option>Schnell</option>
                            </select>
                        </div>
                    `;
                    break;
                    
                case 'listen':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Timeout (Sekunden)</label>
                            <input type="number" class="form-input" value="${node.properties.timeout}" min="1" max="30">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Erwartete Antworten</label>
                            <textarea class="form-textarea" placeholder="ja, nein, hilfe, wiederholen">${node.properties.expectedInputs.join(', ')}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bei Nichtverstehen</label>
                            <select class="form-select">
                                <option>Nachfragen</option>
                                <option>Wiederholen</option>
                                <option>Weiterleiten</option>
                            </select>
                        </div>
                    `;
                    break;
                    
                case 'condition':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Bedingung</label>
                            <input type="text" class="form-input" value="${node.properties.condition}" placeholder="z.B. input == 'hilfe'">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Wenn WAHR</label>
                            <input type="text" class="form-input" value="${node.properties.trueAction}" placeholder="N√§chste Aktion">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Wenn FALSCH</label>
                            <input type="text" class="form-input" value="${node.properties.falseAction}" placeholder="Alternative Aktion">
                        </div>
                    `;
                    break;
                    
                case 'transfer':
                    html = `
                        <div class="form-group">
                            <label class="form-label">Abteilung</label>
                            <select class="form-select">
                                <option>Kundenservice</option>
                                <option>Vertrieb</option>
                                <option>Technik</option>
                                <option>Buchhaltung</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Weiterleitungs-Nachricht</label>
                            <textarea class="form-textarea">${node.properties.message}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Wartemusik</label>
                            <select class="form-select">
                                <option>Standard</option>
                                <option>Klassik</option>
                                <option>Jazz</option>
                                <option>Keine</option>
                            </select>
                        </div>
                    `;
                    break;
                    
                default:
                    html = '<p>Keine spezifischen Einstellungen verf√ºgbar.</p>';
            }
            
            return html;
        }
        
        // Utility Functions
        function hideWelcomeState() {
            document.getElementById('welcome-state').style.display = 'none';
        }
        
        function updateAgentName() {
            const input = document.getElementById('agent-name-input');
            const breadcrumb = document.getElementById('agent-name');
            
            input.addEventListener('input', function() {
                breadcrumb.textContent = this.value || 'Neuer Agent';
            });
        }
        
        // Voice Preview
        function updateVoicePreview() {
            const select = document.getElementById('voice-select');
            const waveform = document.querySelector('.waveform');
            waveform.textContent = `${select.options[select.selectedIndex].text} - Klicke zum Abspielen`;
        }
        
        function playVoicePreview() {
            const playBtn = document.querySelector('.play-btn');
            const waveform = document.querySelector('.waveform');
            
            playBtn.innerHTML = '<i class="fas fa-stop"></i>';
            waveform.textContent = 'üéµ Spielt ab...';
            waveform.style.opacity = '1';
            
            setTimeout(() => {
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                waveform.textContent = 'Klicke zum Abspielen';
                waveform.style.opacity = '0.3';
            }, 2000);
        }
        
        // Test Panel Functions
        function openTestPanel() {
            document.getElementById('test-panel').classList.add('open');
        }
        
        function closeTestPanel() {
            document.getElementById('test-panel').classList.remove('open');
        }
        
        function startNewCall() {
            const transcript = document.getElementById('transcript');
            transcript.innerHTML = `
                <div><strong>System:</strong> Verbindung wird aufgebaut...</div>
                <div><strong>Agent:</strong> ${document.querySelector('#agent-name-input').value || 'Hallo'}, wie kann ich Ihnen helfen?</div>
            `;
        }
        
        function endCall() {
            closeTestPanel();
            alert('üìû Testanruf beendet!\n\nDauer: 1:23 min\nStatus: Erfolgreich\nKundenzufriedenheit: 98%');
        }
        
        // Header Functions
        function saveAgent() {
            const agentName = document.getElementById('agent-name-input').value || 'Unbenannt';
            alert(`üíæ Agent "${agentName}" wurde gespeichert!\n\n${nodes.length} Komponenten konfiguriert.`);
        }
        
        function testAgent() {
            if (nodes.length === 0) {
                alert('‚ö†Ô∏è F√ºge zuerst Komponenten hinzu, um den Agent zu testen!');
                return;
            }
            openTestPanel();
            startNewCall();
        }
        
        function showUserMenu() {
            alert('üë§ User-Men√º\n\n‚Ä¢ Profil bearbeiten\n‚Ä¢ Einstellungen\n‚Ä¢ Abmelden');
        }
        
        // Keyboard Shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveAgent();
                        break;
                    case 't':
                        e.preventDefault();
                        testAgent();
                        break;
                    case 'Delete':
                    case 'Backspace':
                        if (selectedNode) {
                            deleteSelectedNode();
                        }
                        break;
                }
            }
        });
        
        function deleteSelectedNode() {
            if (!selectedNode) return;
            
            const nodeElement = document.getElementById(selectedNode.id);
            if (nodeElement) {
                nodeElement.remove();
                nodes = nodes.filter(n => n.id !== selectedNode.id);
                selectedNode = null;
                showAgentProperties();
                
                if (nodes.length === 0) {
                    document.getElementById('welcome-state').style.display = 'block';
                }
            }
        }
        
        // Auto-save every 30 seconds
        setInterval(() => {
            if (nodes.length > 0) {
                console.log('üîÑ Auto-save:', nodes.length, 'Komponenten');
            }
        }, 30000);
    </script>
</body>
</html>