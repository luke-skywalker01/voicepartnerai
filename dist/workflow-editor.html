<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Scheduler - Workflow Editor | VoicePartnerAI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0a0a0f;
            color: #ffffff;
            overflow: hidden;
        }

        /* Dark Theme Variables */
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #1a1a1f;
            --bg-tertiary: #2a2a30;
            --bg-card: #161618;
            --bg-node: #1e1e23;
            --border-primary: #2a2a30;
            --border-secondary: #3a3a40;
            --text-primary: #ffffff;
            --text-secondary: #b4b4b8;
            --text-muted: #6b6b70;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-purple: #8b5cf6;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --accent-yellow: #eab308;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            position: relative;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .back-button:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .workflow-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .workflow-name {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .workflow-id {
            color: var(--text-muted);
            font-size: 0.875rem;
            font-family: monospace;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .unsaved-indicator {
            background: var(--accent-orange);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-secondary);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Left Sidebar - Node Library */
        .node-library {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .library-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .library-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .library-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
        }

        .library-close:hover {
            background: var(--bg-tertiary);
        }

        .node-category {
            padding: 1rem;
        }

        .node-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .node-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .node-item:hover {
            background: var(--bg-card);
            border-color: var(--border-secondary);
        }

        .node-item:active {
            cursor: grabbing;
        }

        .node-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
        }

        .node-icon.conversation {
            background: var(--accent-blue);
        }

        .node-icon.api {
            background: var(--accent-purple);
        }

        .node-icon.transfer {
            background: var(--accent-green);
        }

        .node-icon.end {
            background: var(--accent-red);
        }

        .node-icon.tool {
            background: var(--accent-orange);
        }

        .node-details {
            flex: 1;
        }

        .node-name {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .node-shortcut {
            color: var(--text-muted);
            font-size: 0.75rem;
            font-family: monospace;
        }

        /* Canvas Area */
        .canvas-container {
            flex: 1;
            position: relative;
            background: 
                radial-gradient(circle at 20px 20px, #1a1a1f 1px, transparent 1px),
                var(--bg-primary);
            background-size: 20px 20px;
            overflow: hidden;
        }

        .canvas {
            width: 100%;
            height: 100%;
            position: relative;
            cursor: grab;
        }

        .canvas.panning {
            cursor: grabbing;
        }

        /* Workflow Nodes */
        .workflow-node {
            position: absolute;
            background: var(--bg-node);
            border: 2px solid var(--border-primary);
            border-radius: 12px;
            min-width: 200px;
            cursor: move;
            transition: all 0.2s;
            user-select: none;
        }

        .workflow-node.selected {
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .workflow-node:hover {
            border-color: var(--border-secondary);
        }

        .node-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-primary);
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px 10px 0 0;
        }

        .node-type-icon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
        }

        .node-title {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.875rem;
            flex: 1;
        }

        .node-id {
            color: var(--text-muted);
            font-size: 0.75rem;
            font-family: monospace;
        }

        .node-content {
            padding: 1rem;
        }

        .node-preview {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
            margin-bottom: 0.75rem;
        }

        .node-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
        }

        .node-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-muted);
        }

        .node-stat i {
            font-size: 0.65rem;
        }

        /* Connection Points */
        .connection-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--bg-primary);
            border: 2px solid var(--border-secondary);
            border-radius: 50%;
            cursor: crosshair;
            transition: all 0.2s;
            z-index: 10;
        }

        .connection-point.input {
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connection-point.output {
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connection-point:hover {
            border-color: var(--accent-blue);
            background: var(--accent-blue);
            transform: translateY(-50%) scale(1.2);
        }

        /* Right Properties Panel */
        .properties-panel {
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .properties-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .properties-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .properties-subtitle {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .properties-content {
            padding: 1rem;
        }

        .property-group {
            margin-bottom: 1.5rem;
        }

        .property-label {
            display: block;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .property-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .property-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        /* SVG Connections */
        .connections-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .connection-path {
            fill: none;
            stroke: var(--accent-blue);
            stroke-width: 2;
            opacity: 0.8;
        }

        .connection-path.condition {
            stroke: var(--accent-yellow);
        }

        .connection-label {
            fill: var(--bg-primary);
            stroke: var(--accent-yellow);
            stroke-width: 1;
            font-size: 12px;
            font-weight: 600;
        }

        /* Toolbar */
        .canvas-toolbar {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 0.5rem;
            z-index: 100;
        }

        .toolbar-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .toolbar-btn.active {
            background: var(--accent-blue);
            color: white;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 100;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .zoom-level {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            color: var(--text-secondary);
            padding: 0.5rem;
            font-size: 0.75rem;
            text-align: center;
            min-width: 60px;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 0.5rem 0;
            min-width: 160px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .context-menu-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .context-menu-item.danger {
            color: var(--accent-red);
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border-primary);
            margin: 0.5rem 0;
        }

        /* Connection Lines */
        .connection-line {
            fill: none;
            stroke: var(--text-tertiary);
            stroke-width: 2px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .connection-line:hover {
            stroke: var(--accent-primary);
            stroke-width: 3px;
        }

        .connection-line.temporary {
            stroke: var(--accent-primary);
            stroke-width: 2px;
            stroke-dasharray: 5,5;
            pointer-events: none;
        }

        .connection-point.highlighted {
            background: var(--accent-primary) !important;
            transform: scale(1.3);
        }

        .canvas.connecting {
            cursor: crosshair;
        }

        .canvas.connecting .workflow-node {
            pointer-events: none;
        }

        .canvas.connecting .connection-point {
            pointer-events: auto;
        }

        /* Validation Panel */
        .validation-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90vw;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
        }

        .validation-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .validation-success {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--accent-green);
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 8px;
        }

        .validation-errors {
            margin-bottom: 1.5rem;
        }

        .validation-errors h4 {
            color: var(--accent-red);
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }

        .validation-errors ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .validation-errors li {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-red);
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 6px;
        }

        .validation-warnings {
            margin-bottom: 1.5rem;
        }

        .validation-warnings h4 {
            color: var(--accent-yellow);
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }

        .validation-warnings ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .validation-warnings li {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-yellow);
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 6px;
        }

        /* Execution Animation */
        .workflow-node.executing {
            animation: nodeExecuting 1s ease-in-out;
            border: 2px solid var(--accent-primary);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        .connection-line.executing {
            stroke: var(--accent-primary);
            stroke-width: 4px;
            animation: connectionExecuting 1s ease-in-out;
        }

        @keyframes nodeExecuting {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes connectionExecuting {
            0% { stroke-dasharray: 0, 1000; }
            100% { stroke-dasharray: 1000, 0; }
        }

        /* Minimap */
        .minimap {
            position: absolute;
            bottom: 2rem;
            left: 2rem;
            width: 200px;
            height: 120px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            z-index: 100;
        }

        .minimap-viewport {
            position: absolute;
            border: 2px solid var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button class="back-button" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="workflow-title">
                <div class="workflow-name">Appointment Scheduler</div>
                <div class="workflow-id">6xaAAiFp4TjwbadGsfrBDDANrI</div>
            </div>
        </div>
        
        <div class="header-actions">
            <div class="unsaved-indicator">
                ⚠ Unsaved changes
            </div>
            
            <button class="btn btn-primary" onclick="playWorkflow()" title="Test Workflow">
                <i class="fas fa-play"></i>
                Test
            </button>
            
            <button class="btn btn-secondary">
                <i class="fas fa-phone"></i>
                Call
                <i class="fas fa-chevron-down"></i>
            </button>
            
            <button class="btn btn-success" onclick="saveWorkflow()">
                <i class="fas fa-save"></i>
                Save
            </button>
            
            <button class="btn btn-secondary">
                <i class="fas fa-ellipsis-h"></i>
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar - Node Library -->
        <div class="node-library" id="nodeLibrary">
            <div class="library-header">
                <h3 class="library-title">Add a Node</h3>
                <button class="library-close" onclick="toggleNodeLibrary()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="node-category">
                <div class="node-list">
                    <div class="node-item" draggable="true" data-node-type="conversation">
                        <div class="node-icon conversation">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="node-details">
                            <div class="node-name">Conversation</div>
                            <div class="node-shortcut">Ctrl + Shift + C</div>
                        </div>
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="api">
                        <div class="node-icon api">
                            <i class="fas fa-globe"></i>
                        </div>
                        <div class="node-details">
                            <div class="node-name">API Request</div>
                            <div class="node-shortcut">Ctrl + Shift + A</div>
                        </div>
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="transfer">
                        <div class="node-icon transfer">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <div class="node-details">
                            <div class="node-name">Transfer Call</div>
                            <div class="node-shortcut">Ctrl + Shift + T</div>
                        </div>
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="end">
                        <div class="node-icon end">
                            <i class="fas fa-phone-slash"></i>
                        </div>
                        <div class="node-details">
                            <div class="node-name">End Call</div>
                            <div class="node-shortcut">Ctrl + Shift + E</div>
                        </div>
                    </div>
                    
                    <div class="node-item" draggable="true" data-node-type="tool">
                        <div class="node-icon tool">
                            <i class="fas fa-wrench"></i>
                        </div>
                        <div class="node-details">
                            <div class="node-name">Tool</div>
                            <div class="node-shortcut">Ctrl + Shift + O</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-container" id="canvasContainer">
            <div class="canvas" id="canvas">
                <!-- SVG for connections -->
                <svg class="connections-svg" id="connectionsSvg">
                    <!-- Connections will be drawn here -->
                </svg>

                <!-- Default Start Node -->
                <div class="workflow-node" id="startNode" style="left: 1200px; top: 100px;">
                    <div class="connection-point output"></div>
                    <div class="node-header">
                        <div class="node-type-icon conversation">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="node-title">start</div>
                        <div class="node-id">5 🔗 ⋯</div>
                    </div>
                    <div class="node-content">
                        <div class="node-preview">
                            First Message:<br>
                            Thank you for calling Wellness Partners. This is Riley, your scheduling assistant. How may I help you today?
                        </div>
                        <div class="node-stats">
                            <div class="node-stat">
                                <span>Prompt:</span>
                                <span>You are Riley, appointment scheduling assistant for Wellness Partners Health Clinic...</span>
                            </div>
                        </div>
                        <div class="node-stats">
                            <div class="node-stat">
                                <i class="fas fa-dollar-sign"></i>
                                <span>$0.00/min</span>
                            </div>
                            <div class="node-stat">
                                <i class="fas fa-clock"></i>
                                <span>Latency: 1.1s</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Canvas Toolbar -->
            <div class="canvas-toolbar">
                <button class="toolbar-btn" title="Select Tool" onclick="setTool('select')">
                    <i class="fas fa-mouse-pointer"></i>
                </button>
                <button class="toolbar-btn" title="Hand Tool" onclick="setTool('hand')">
                    <i class="fas fa-hand-paper"></i>
                </button>
                <button class="toolbar-btn" title="Comment" onclick="setTool('comment')">
                    <i class="fas fa-comment"></i>
                </button>
                <button class="toolbar-btn" title="Undo">
                    <i class="fas fa-undo"></i>
                </button>
                <button class="toolbar-btn" title="Redo">
                    <i class="fas fa-redo"></i>
                </button>
                <button class="toolbar-btn" title="Fit to Screen">
                    <i class="fas fa-expand-arrows-alt"></i>
                </button>
                <button class="toolbar-btn" title="Find">
                    <i class="fas fa-search"></i>
                </button>
                <button class="toolbar-btn" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
            </div>

            <!-- Zoom Controls -->
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()">
                    <i class="fas fa-plus"></i>
                </button>
                <div class="zoom-level" id="zoomLevel">100%</div>
                <button class="zoom-btn" onclick="zoomOut()">
                    <i class="fas fa-minus"></i>
                </button>
            </div>

            <!-- Minimap -->
            <div class="minimap">
                <div class="minimap-viewport"></div>
            </div>
        </div>

        <!-- Right Properties Panel -->
        <div class="properties-panel" id="propertiesPanel">
            <div class="properties-header">
                <h3 class="properties-title">Node Properties</h3>
                <p class="properties-subtitle">Configure the selected node</p>
            </div>
            
            <div class="properties-content" id="propertiesContent">
                <div class="property-group">
                    <label class="property-label">Node Type</label>
                    <input type="text" class="property-input" value="Conversation" readonly>
                </div>
                
                <div class="property-group">
                    <label class="property-label">Node Name</label>
                    <input type="text" class="property-input" value="start" placeholder="Enter node name...">
                </div>
                
                <div class="property-group">
                    <label class="property-label">First Message</label>
                    <textarea class="property-input property-textarea" placeholder="Enter first message...">Thank you for calling Wellness Partners. This is Riley, your scheduling assistant. How may I help you today?</textarea>
                </div>
                
                <div class="property-group">
                    <label class="property-label">System Prompt</label>
                    <textarea class="property-input property-textarea" placeholder="Enter system prompt...">You are Riley, appointment scheduling assistant for Wellness Partners Health Clinic. Start with: Thank you for calling Wellness Partners. This is Riley, your scheduling assistant. How may I help you today? Listen for scheduling, rescheduling, canceling, or general questions.</textarea>
                </div>
                
                <div class="property-group">
                    <label class="property-label">Model</label>
                    <select class="property-input">
                        <option>GPT-4o Mini Cluster</option>
                        <option>GPT-4o</option>
                        <option>Claude 3.5 Sonnet</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="duplicateNode()">
            <i class="fas fa-copy"></i>
            Duplicate
        </div>
        <div class="context-menu-item" onclick="editNode()">
            <i class="fas fa-edit"></i>
            Edit
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" onclick="deleteNode()">
            <i class="fas fa-trash"></i>
            Delete
        </div>
    </div>

    <script>
        console.log('🎨 VoicePartnerAI Workflow Editor loaded');
        
        // Global state
        let currentTool = 'select';
        let selectedNode = document.getElementById('startNode');
        let zoomLevel = 1.0;
        let panOffset = { x: 0, y: 0 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let nodeCounter = 1;
        let connections = [];
        let isConnecting = false;
        let connectionStart = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            initializeConnectionPoints();
            initializeWorkflowFromParams();
            selectNode(selectedNode);
            updateMinimap();
        });

        function initializeEventListeners() {
            const canvas = document.getElementById('canvas');
            const canvasContainer = document.getElementById('canvasContainer');
            
            // Canvas pan and zoom
            canvasContainer.addEventListener('wheel', handleCanvasWheel);
            canvas.addEventListener('mousedown', handleCanvasMouseDown);
            canvas.addEventListener('mousemove', handleCanvasMouseMove);
            canvas.addEventListener('mouseup', handleCanvasMouseUp);
            
            // Node drag and drop from library
            const nodeItems = document.querySelectorAll('.node-item');
            nodeItems.forEach(item => {
                item.addEventListener('dragstart', handleNodeDragStart);
            });
            
            canvasContainer.addEventListener('dragover', handleCanvasDragOver);
            canvasContainer.addEventListener('drop', handleCanvasDrop);
            
            // Context menu
            canvas.addEventListener('contextmenu', handleContextMenu);
            document.addEventListener('click', hideContextMenu);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboard);
        }

        // Node selection
        function selectNode(node) {
            // Remove selection from all nodes
            document.querySelectorAll('.workflow-node').forEach(n => {
                n.classList.remove('selected');
            });
            
            // Select the clicked node
            if (node) {
                node.classList.add('selected');
                selectedNode = node;
                updatePropertiesPanel(node);
            }
        }

        // Update properties panel based on selected node
        function updatePropertiesPanel(node) {
            if (!node) return;
            
            const nodeType = node.dataset.nodeType || 'conversation';
            const nodeName = node.querySelector('.node-title').textContent;
            
            console.log(`📝 Updating properties for ${nodeType} node: ${nodeName}`);
        }

        // Canvas interaction
        function handleCanvasWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            zoomLevel = Math.max(0.1, Math.min(3, zoomLevel + delta));
            updateZoomLevel();
        }

        function handleCanvasMouseDown(e) {
            if (e.target.classList.contains('workflow-node') || e.target.closest('.workflow-node')) {
                const node = e.target.classList.contains('workflow-node') ? e.target : e.target.closest('.workflow-node');
                selectNode(node);
                return;
            }
            
            if (currentTool === 'hand' || e.button === 1) { // Middle mouse button
                isDragging = true;
                dragStart = { x: e.clientX, y: e.clientY };
                document.getElementById('canvas').classList.add('panning');
            }
        }

        function handleCanvasMouseMove(e) {
            if (isDragging) {
                const dx = e.clientX - dragStart.x;
                const dy = e.clientY - dragStart.y;
                
                panOffset.x += dx;
                panOffset.y += dy;
                
                dragStart = { x: e.clientX, y: e.clientY };
                updateCanvasTransform();
            }
        }

        function handleCanvasMouseUp(e) {
            isDragging = false;
            document.getElementById('canvas').classList.remove('panning');
        }

        // Drag and drop from node library
        function handleNodeDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.nodeType);
            console.log(`🎯 Started dragging ${e.target.dataset.nodeType} node`);
        }

        function handleCanvasDragOver(e) {
            e.preventDefault();
        }

        function handleCanvasDrop(e) {
            e.preventDefault();
            const nodeType = e.dataTransfer.getData('text/plain');
            const rect = document.getElementById('canvasContainer').getBoundingClientRect();
            const x = e.clientX - rect.left - panOffset.x;
            const y = e.clientY - rect.top - panOffset.y;
            
            createNode(nodeType, x, y);
        }

        // Create new workflow node
        function createNode(type, x, y) {
            nodeCounter++;
            const nodeId = `${type}_${nodeCounter}`;
            
            const nodeTemplates = {
                conversation: {
                    icon: 'fas fa-comments',
                    title: 'conversation',
                    preview: 'AI conversation node with configurable prompts and responses.',
                    color: 'conversation'
                },
                api: {
                    icon: 'fas fa-globe',
                    title: 'api_request',
                    preview: 'Make external API calls to integrate with third-party services.',
                    color: 'api'
                },
                transfer: {
                    icon: 'fas fa-phone-alt',
                    title: 'transfer_call',
                    preview: 'Transfer the call to a human agent or another number.',
                    color: 'transfer'
                },
                end: {
                    icon: 'fas fa-phone-slash',
                    title: 'end_call',
                    preview: 'End the conversation and hang up the call.',
                    color: 'end'
                },
                tool: {
                    icon: 'fas fa-wrench',
                    title: 'tool',
                    preview: 'Execute custom functions or integrations.',
                    color: 'tool'
                }
            };
            
            const template = nodeTemplates[type] || nodeTemplates.conversation;
            
            const nodeElement = document.createElement('div');
            nodeElement.className = 'workflow-node';
            nodeElement.id = nodeId;
            nodeElement.dataset.nodeType = type;
            nodeElement.style.left = `${x}px`;
            nodeElement.style.top = `${y}px`;
            
            nodeElement.innerHTML = `
                <div class="connection-point input"></div>
                <div class="connection-point output"></div>
                <div class="node-header">
                    <div class="node-type-icon ${template.color}">
                        <i class="${template.icon}"></i>
                    </div>
                    <div class="node-title">${template.title}</div>
                    <div class="node-id">${nodeCounter} 🔗 ⋯</div>
                </div>
                <div class="node-content">
                    <div class="node-preview">${template.preview}</div>
                    <div class="node-stats">
                        <div class="node-stat">
                            <i class="fas fa-dollar-sign"></i>
                            <span>$0.00/min</span>
                        </div>
                        <div class="node-stat">
                            <i class="fas fa-clock"></i>
                            <span>Latency: 1.2s</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('canvas').appendChild(nodeElement);
            
            // Add click handler for selection
            nodeElement.addEventListener('click', (e) => {
                e.stopPropagation();
                selectNode(nodeElement);
            });
            
            // Initialize connection points for the new node
            const outputPoint = nodeElement.querySelector('.connection-point.output');
            const inputPoint = nodeElement.querySelector('.connection-point.input');
            
            if (outputPoint) {
                outputPoint.addEventListener('mousedown', startConnection);
            }
            
            if (inputPoint) {
                inputPoint.addEventListener('mouseup', endConnection);
                inputPoint.addEventListener('mouseenter', highlightConnectionPoint);
                inputPoint.addEventListener('mouseleave', unhighlightConnectionPoint);
            }
            
            selectNode(nodeElement);
            console.log(`✅ Created ${type} node at (${x}, ${y})`);
        }

        // Tool management
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.toolbar-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.toolbar-btn').classList.add('active');
            console.log(`🔧 Set tool to: ${tool}`);
        }

        // Zoom controls
        function zoomIn() {
            zoomLevel = Math.min(3, zoomLevel + 0.1);
            updateZoomLevel();
        }

        function zoomOut() {
            zoomLevel = Math.max(0.1, zoomLevel - 0.1);
            updateZoomLevel();
        }

        function updateZoomLevel() {
            document.getElementById('zoomLevel').textContent = `${Math.round(zoomLevel * 100)}%`;
            updateCanvasTransform();
        }

        function updateCanvasTransform() {
            const canvas = document.getElementById('canvas');
            canvas.style.transform = `translate(${panOffset.x}px, ${panOffset.y}px) scale(${zoomLevel})`;
            redrawAllConnections();
        }

        // Context menu
        function handleContextMenu(e) {
            e.preventDefault();
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.style.top = `${e.clientY}px`;
            contextMenu.style.display = 'block';
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
        }

        // Context menu actions
        function duplicateNode() {
            if (selectedNode) {
                const rect = selectedNode.getBoundingClientRect();
                const type = selectedNode.dataset.nodeType || 'conversation';
                createNode(type, rect.left + 50, rect.top + 50);
            }
            hideContextMenu();
        }

        function editNode() {
            console.log('📝 Editing node:', selectedNode?.id);
            hideContextMenu();
        }

        function deleteNode() {
            if (selectedNode && selectedNode.id !== 'startNode') {
                selectedNode.remove();
                selectedNode = document.getElementById('startNode');
                selectNode(selectedNode);
            }
            hideContextMenu();
        }

        // Keyboard shortcuts
        function handleKeyboard(e) {
            if (e.ctrlKey && e.shiftKey) {
                switch(e.key) {
                    case 'C':
                        e.preventDefault();
                        createNode('conversation', 400, 200);
                        break;
                    case 'A':
                        e.preventDefault();
                        createNode('api', 400, 200);
                        break;
                    case 'T':
                        e.preventDefault();
                        createNode('transfer', 400, 200);
                        break;
                    case 'E':
                        e.preventDefault();
                        createNode('end', 400, 200);
                        break;
                    case 'O':
                        e.preventDefault();
                        createNode('tool', 400, 200);
                        break;
                }
            }
            
            if (e.key === 'Delete' && selectedNode && selectedNode.id !== 'startNode') {
                deleteNode();
            }
        }

        // Node Connection System
        function initializeConnectionPoints() {
            const nodes = document.querySelectorAll('.workflow-node');
            nodes.forEach(node => {
                const outputPoint = node.querySelector('.connection-point.output');
                const inputPoint = node.querySelector('.connection-point.input');
                
                if (outputPoint) {
                    outputPoint.addEventListener('mousedown', startConnection);
                }
                
                if (inputPoint) {
                    inputPoint.addEventListener('mouseup', endConnection);
                    inputPoint.addEventListener('mouseenter', highlightConnectionPoint);
                    inputPoint.addEventListener('mouseleave', unhighlightConnectionPoint);
                }
            });
        }
        
        function startConnection(e) {
            e.stopPropagation();
            if (currentTool !== 'select') return;
            
            isConnecting = true;
            connectionStart = e.target.closest('.workflow-node');
            
            const canvas = document.getElementById('canvas');
            canvas.classList.add('connecting');
            
            document.addEventListener('mousemove', drawTemporaryConnection);
            document.addEventListener('mouseup', cancelConnection);
            
            console.log('🔗 Started connection from', connectionStart.id);
        }
        
        function endConnection(e) {
            if (!isConnecting || !connectionStart) return;
            
            e.stopPropagation();
            const connectionEnd = e.target.closest('.workflow-node');
            
            if (connectionEnd && connectionEnd !== connectionStart) {
                createConnection(connectionStart, connectionEnd);
            }
            
            cancelConnection();
        }
        
        function cancelConnection() {
            isConnecting = false;
            connectionStart = null;
            
            const canvas = document.getElementById('canvas');
            canvas.classList.remove('connecting');
            
            document.removeEventListener('mousemove', drawTemporaryConnection);
            document.removeEventListener('mouseup', cancelConnection);
            
            // Remove temporary connection line
            const tempLine = document.getElementById('tempConnection');
            if (tempLine) tempLine.remove();
        }
        
        function drawTemporaryConnection(e) {
            if (!isConnecting || !connectionStart) return;
            
            const canvas = document.getElementById('canvas');
            const canvasRect = canvas.getBoundingClientRect();
            
            const startPoint = getConnectionPoint(connectionStart, 'output');
            const endPoint = {
                x: e.clientX - canvasRect.left,
                y: e.clientY - canvasRect.top
            };
            
            drawConnectionLine('tempConnection', startPoint, endPoint, true);
        }
        
        function createConnection(fromNode, toNode) {
            const connectionId = `connection_${fromNode.id}_${toNode.id}`;
            
            // Check if connection already exists
            if (connections.find(conn => conn.id === connectionId)) {
                console.log('⚠️ Connection already exists');
                return;
            }
            
            const connection = {
                id: connectionId,
                from: fromNode.id,
                to: toNode.id,
                fromNode: fromNode,
                toNode: toNode
            };
            
            connections.push(connection);
            drawConnection(connection);
            
            console.log('✅ Created connection:', connectionId);
        }
        
        function drawConnection(connection) {
            const startPoint = getConnectionPoint(connection.fromNode, 'output');
            const endPoint = getConnectionPoint(connection.toNode, 'input');
            
            drawConnectionLine(connection.id, startPoint, endPoint, false);
        }
        
        function drawConnectionLine(id, startPoint, endPoint, isTemporary = false) {
            // Remove existing line with same ID
            const existingLine = document.getElementById(id);
            if (existingLine) existingLine.remove();
            
            const svg = getOrCreateSVGLayer();
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            
            path.id = id;
            path.setAttribute('class', isTemporary ? 'connection-line temporary' : 'connection-line');
            
            // Create bezier curve path
            const pathData = createBezierPath(startPoint, endPoint);
            path.setAttribute('d', pathData);
            
            svg.appendChild(path);
            
            if (!isTemporary) {
                // Add click handler for connection deletion
                path.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteConnection(id);
                });
            }
        }
        
        function createBezierPath(start, end) {
            const dx = end.x - start.x;
            const dy = end.y - start.y;
            
            // Control points for smooth bezier curve
            const cp1x = start.x + Math.max(50, Math.abs(dx) * 0.5);
            const cp1y = start.y;
            const cp2x = end.x - Math.max(50, Math.abs(dx) * 0.5);
            const cp2y = end.y;
            
            return `M ${start.x} ${start.y} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${end.x} ${end.y}`;
        }
        
        function getConnectionPoint(node, type) {
            const nodeRect = node.getBoundingClientRect();
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            
            const relativeX = nodeRect.left - canvasRect.left + (nodeRect.width / 2);
            const relativeY = nodeRect.top - canvasRect.top + (type === 'output' ? nodeRect.height : 0);
            
            return {
                x: relativeX,
                y: relativeY
            };
        }
        
        function getOrCreateSVGLayer() {
            let svg = document.getElementById('connectionSVG');
            if (!svg) {
                svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.id = 'connectionSVG';
                svg.style.position = 'absolute';
                svg.style.top = '0';
                svg.style.left = '0';
                svg.style.width = '100%';
                svg.style.height = '100%';
                svg.style.pointerEvents = 'none';
                svg.style.zIndex = '1';
                
                // Make paths clickable
                svg.style.pointerEvents = 'visiblePainted';
                
                document.getElementById('canvas').appendChild(svg);
            }
            return svg;
        }
        
        function deleteConnection(connectionId) {
            const connectionIndex = connections.findIndex(conn => conn.id === connectionId);
            if (connectionIndex !== -1) {
                connections.splice(connectionIndex, 1);
                const line = document.getElementById(connectionId);
                if (line) line.remove();
                console.log('🗑️ Deleted connection:', connectionId);
            }
        }
        
        function highlightConnectionPoint(e) {
            if (isConnecting) {
                e.target.classList.add('highlighted');
            }
        }
        
        function unhighlightConnectionPoint(e) {
            e.target.classList.remove('highlighted');
        }
        
        function redrawAllConnections() {
            connections.forEach(connection => {
                drawConnection(connection);
            });
        }
        
        // Workflow Validation and Testing
        function validateWorkflow() {
            const errors = [];
            const warnings = [];
            const nodes = document.querySelectorAll('.workflow-node');
            
            // Check for disconnected nodes
            nodes.forEach(node => {
                if (node.id === 'startNode') return;
                
                const hasInput = connections.some(conn => conn.to === node.id);
                if (!hasInput) {
                    warnings.push(`Node "${node.querySelector('.node-title').textContent}" has no incoming connections`);
                }
            });
            
            // Check for nodes without outputs (except end nodes)
            nodes.forEach(node => {
                const nodeType = node.dataset.nodeType;
                if (nodeType === 'end') return;
                
                const hasOutput = connections.some(conn => conn.from === node.id);
                if (!hasOutput) {
                    warnings.push(`Node "${node.querySelector('.node-title').textContent}" has no outgoing connections`);
                }
            });
            
            // Check for circular dependencies
            const visited = new Set();
            const recursionStack = new Set();
            
            function hasCycle(nodeId) {
                if (recursionStack.has(nodeId)) return true;
                if (visited.has(nodeId)) return false;
                
                visited.add(nodeId);
                recursionStack.add(nodeId);
                
                const outgoingConnections = connections.filter(conn => conn.from === nodeId);
                for (const conn of outgoingConnections) {
                    if (hasCycle(conn.to)) return true;
                }
                
                recursionStack.delete(nodeId);
                return false;
            }
            
            if (hasCycle('startNode')) {
                errors.push('Circular dependency detected in workflow');
            }
            
            return { errors, warnings };
        }
        
        function testWorkflow() {
            console.log('🧪 Testing workflow...');
            const validation = validateWorkflow();
            
            // Show validation results
            showValidationResults(validation);
            
            if (validation.errors.length === 0) {
                // Simulate workflow execution
                simulateWorkflowExecution();
            }
        }
        
        function showValidationResults(validation) {
            const { errors, warnings } = validation;
            
            // Create or update validation panel
            let panel = document.getElementById('validationPanel');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'validationPanel';
                panel.className = 'validation-panel';
                document.body.appendChild(panel);
            }
            
            let content = '<div class="validation-header">Workflow Validation Results</div>';
            
            if (errors.length === 0 && warnings.length === 0) {
                content += '<div class="validation-success"><i class="fas fa-check-circle"></i> Workflow is valid!</div>';
            } else {
                if (errors.length > 0) {
                    content += '<div class="validation-errors"><h4>Errors:</h4><ul>';
                    errors.forEach(error => {
                        content += `<li><i class="fas fa-times-circle"></i> ${error}</li>`;
                    });
                    content += '</ul></div>';
                }
                
                if (warnings.length > 0) {
                    content += '<div class="validation-warnings"><h4>Warnings:</h4><ul>';
                    warnings.forEach(warning => {
                        content += `<li><i class="fas fa-exclamation-triangle"></i> ${warning}</li>`;
                    });
                    content += '</ul></div>';
                }
            }
            
            content += '<button class="btn btn-secondary" onclick="closeValidationPanel()">Close</button>';
            panel.innerHTML = content;
            panel.style.display = 'block';
        }
        
        function closeValidationPanel() {
            const panel = document.getElementById('validationPanel');
            if (panel) panel.style.display = 'none';
        }
        
        function simulateWorkflowExecution() {
            console.log('🚀 Simulating workflow execution...');
            
            // Highlight workflow path
            const executionOrder = [];
            let currentNode = 'startNode';
            const visitedNodes = new Set();
            
            while (currentNode && !visitedNodes.has(currentNode)) {
                visitedNodes.add(currentNode);
                executionOrder.push(currentNode);
                
                // Find next node
                const connection = connections.find(conn => conn.from === currentNode);
                currentNode = connection ? connection.to : null;
            }
            
            // Animate execution path
            animateWorkflowExecution(executionOrder);
        }
        
        function animateWorkflowExecution(executionOrder) {
            let step = 0;
            
            function highlightStep() {
                // Remove previous highlights
                document.querySelectorAll('.workflow-node').forEach(node => {
                    node.classList.remove('executing');
                });
                document.querySelectorAll('.connection-line').forEach(line => {
                    line.classList.remove('executing');
                });
                
                if (step < executionOrder.length) {
                    const nodeId = executionOrder[step];
                    const node = document.getElementById(nodeId);
                    if (node) {
                        node.classList.add('executing');
                    }
                    
                    // Highlight connection to next node
                    if (step < executionOrder.length - 1) {
                        const nextNodeId = executionOrder[step + 1];
                        const connectionId = `connection_${nodeId}_${nextNodeId}`;
                        const connection = document.getElementById(connectionId);
                        if (connection) {
                            connection.classList.add('executing');
                        }
                    }
                    
                    step++;
                    setTimeout(highlightStep, 1000);
                } else {
                    console.log('✅ Workflow execution simulation completed');
                }
            }
            
            highlightStep();
        }
        
        function playWorkflow() {
            console.log('▶️ Playing workflow...');
            testWorkflow();
        }

        // UI Controls
        function toggleNodeLibrary() {
            const library = document.getElementById('nodeLibrary');
            library.style.display = library.style.display === 'none' ? 'flex' : 'none';
        }

        function saveWorkflow() {
            console.log('💾 Saving workflow...');
            document.querySelector('.unsaved-indicator').style.display = 'none';
            
            // Simulate save
            setTimeout(() => {
                document.querySelector('.unsaved-indicator').style.display = 'block';
                console.log('✅ Workflow saved successfully');
            }, 1000);
        }

        function goBack() {
            if (confirm('Are you sure you want to leave? Unsaved changes will be lost.')) {
                window.location.href = '/index.html';
            }
        }
        
        // Initialize workflow from URL parameters
        function initializeWorkflowFromParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const workflowName = urlParams.get('name');
            const template = urlParams.get('template');
            
            if (workflowName) {
                document.querySelector('.workflow-name').textContent = workflowName;
                console.log(`📝 Initialized workflow: ${workflowName} (${template} template)`);
                
                // Update browser title
                document.title = `${workflowName} - Workflow Editor | VoicePartnerAI`;
                
                // Initialize workflow based on template
                initializeWorkflowTemplate(template);
            }
        }
        
        // Initialize different workflow templates
        function initializeWorkflowTemplate(template) {
            const canvas = document.getElementById('canvas');
            const startNode = document.getElementById('startNode');
            
            switch(template) {
                case 'appointment':
                    // Update start node for appointment template
                    startNode.querySelector('.workflow-name').textContent = 'Appointment Scheduler';
                    startNode.querySelector('.node-preview').innerHTML = 
                        'First Message:<br>Thank you for calling Wellness Partners. This is Riley, your scheduling assistant. How may I help you today?';
                    
                    // Add some pre-configured nodes for appointment workflow
                    setTimeout(() => {
                        createNode('conversation', 1500, 200);
                        createNode('api', 1800, 300);
                        createNode('transfer', 1500, 400);
                    }, 100);
                    break;
                    
                case 'lead-qualification':
                    startNode.querySelector('.node-preview').innerHTML = 
                        'First Message:<br>Hello! Thank you for your interest. I\'m here to help qualify your needs and connect you with the right solution.';
                    
                    setTimeout(() => {
                        createNode('conversation', 1500, 200);
                        createNode('tool', 1800, 200);
                        createNode('api', 1500, 350);
                    }, 100);
                    break;
                    
                case 'support-escalation':
                    startNode.querySelector('.node-preview').innerHTML = 
                        'First Message:<br>Hi! I\'m your support assistant. I\'ll help resolve your issue or connect you with a specialist if needed.';
                    
                    setTimeout(() => {
                        createNode('conversation', 1500, 200);
                        createNode('transfer', 1800, 300);
                        createNode('end', 1500, 400);
                    }, 100);
                    break;
                    
                default: // blank template
                    console.log('🎨 Starting with blank workflow template');
                    break;
            }
        }

        function updateMinimap() {
            // Minimap implementation would go here
            console.log('🗺️ Updating minimap');
        }

        // Initialize with start node selected
        setTimeout(() => {
            selectNode(document.getElementById('startNode'));
        }, 100);
    </script>
</body>
</html>