<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Editor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        
        .container { display: flex; height: 100vh; }
        
        .sidebar { 
            width: 300px; 
            background: white; 
            border-right: 1px solid #ddd; 
            padding: 20px;
            overflow-y: auto;
        }
        
        .canvas { 
            flex: 1; 
            background: #f9f9f9; 
            position: relative;
            overflow: hidden;
        }
        
        .node {
            position: absolute;
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            min-width: 150px;
            cursor: move;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            user-select: none;
        }
        
        .node.start { border-color: #28a745; }
        .node.log { border-color: #ffc107; }
        
        .node-title { font-weight: bold; margin-bottom: 10px; }
        .node-content { font-size: 12px; color: #666; }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        
        .btn:hover { background: #0056b3; }
        .btn.success { background: #28a745; }
        .btn.warning { background: #ffc107; color: black; }
        
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .workflow-info {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .edge {
            position: absolute;
            height: 2px;
            background: #007bff;
            transform-origin: left center;
            pointer-events: none;
        }
        
        .grid {
            background-image: 
                radial-gradient(circle, #ccc 1px, transparent 1px);
            background-size: 20px 20px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>Workflow Editor</h2>
            
            <div id="status" class="status info">
                Ready to work...
            </div>
            
            <div class="input-group">
                <label for="workflowId">Workflow ID:</label>
                <input type="text" id="workflowId" value="demo-workflow" />
            </div>
            
            <button class="btn" onclick="loadWorkflow()">Load Workflow</button>
            <button class="btn success" onclick="createDemoWorkflow()">Create Demo</button>
            <button class="btn warning" onclick="executeWorkflow()">Execute Workflow</button>
            
            <hr style="margin: 20px 0;">
            
            <h3>Add Nodes</h3>
            <button class="btn" onclick="addStartNode()">+ Start Node</button>
            <button class="btn" onclick="addLogNode()">+ Log Node</button>
            
            <hr style="margin: 20px 0;">
            
            <div id="workflowInfo" class="workflow-info" style="display: none;">
                <h3>Workflow Info</h3>
                <div id="workflowDetails"></div>
            </div>
            
            <div id="nodeInfo" class="workflow-info" style="display: none;">
                <h3>Selected Node</h3>
                <div id="nodeDetails"></div>
                <div class="input-group">
                    <label for="nodeMessage">Message:</label>
                    <input type="text" id="nodeMessage" placeholder="Log message..." />
                    <button class="btn" onclick="updateNode()" style="margin-top: 10px;">Update Node</button>
                </div>
            </div>
        </div>
        
        <div class="canvas" id="canvas">
            <div class="grid"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8008/api';
        const AUTH_TOKEN = 'token-dev@voicepartner.ai-demo';
        
        let currentWorkflow = null;
        let selectedNode = null;
        let dragNode = null;
        let dragOffset = { x: 0, y: 0 };
        
        // Helper function to get auth headers
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${AUTH_TOKEN}`
            };
        }
        
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        async function loadWorkflow() {
            const workflowId = document.getElementById('workflowId').value;
            if (!workflowId) {
                showStatus('Please enter a workflow ID', 'error');
                return;
            }
            
            try {
                showStatus('Loading workflow...', 'info');
                const response = await fetch(`${API_BASE}/workflows/${workflowId}`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                currentWorkflow = await response.json();
                showStatus(`Loaded: ${currentWorkflow.name}`, 'success');
                renderWorkflow();
                showWorkflowInfo();
            } catch (error) {
                showStatus(`Load failed: ${error.message}`, 'error');
            }
        }
        
        async function createDemoWorkflow() {
            const workflowId = document.getElementById('workflowId').value || 'demo-workflow';
            
            const demoWorkflow = {
                name: 'Demo Workflow',
                description: 'Ein einfacher Demo-Workflow mit Start- und Log-Nodes',
                nodes: [
                    {
                        id: 'start-1',
                        type: 'core.start',
                        position: { x: 100, y: 100 },
                        parameters: {}
                    },
                    {
                        id: 'log-1',
                        type: 'core.log',
                        position: { x: 350, y: 100 },
                        parameters: { message: 'Hallo Workflow!' }
                    },
                    {
                        id: 'log-2',
                        type: 'core.log',
                        position: { x: 600, y: 100 },
                        parameters: { message: 'Ende der Demo' }
                    }
                ],
                connections: [
                    {
                        id: 'edge-1',
                        sourceNodeId: 'start-1',
                        targetNodeId: 'log-1'
                    },
                    {
                        id: 'edge-2',
                        sourceNodeId: 'log-1',
                        targetNodeId: 'log-2'
                    }
                ],
                settings: {
                    autoSave: true,
                    showGrid: true
                },
                active: true
            };
            
            try {
                showStatus('Creating demo workflow...', 'info');
                const response = await fetch(`${API_BASE}/workflows/`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(demoWorkflow)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                showStatus(`Demo created: ${result.id}`, 'success');
                document.getElementById('workflowId').value = result.id;
                await loadWorkflow();
            } catch (error) {
                showStatus(`Create failed: ${error.message}`, 'error');
            }
        }
        
        function renderWorkflow() {
            if (!currentWorkflow) return;
            
            const canvas = document.getElementById('canvas');
            const existingNodes = canvas.querySelectorAll('.node, .edge');
            existingNodes.forEach(node => node.remove());
            
            // Render nodes
            currentWorkflow.nodes.forEach(node => {
                const nodeEl = document.createElement('div');
                nodeEl.className = `node ${node.type.split('.')[1] || 'default'}`;
                nodeEl.style.left = node.position.x + 'px';
                nodeEl.style.top = node.position.y + 'px';
                nodeEl.dataset.nodeId = node.id;
                
                nodeEl.innerHTML = `
                    <div class="node-title">${node.type}</div>
                    <div class="node-content">${node.parameters.message || node.id}</div>
                `;
                
                nodeEl.addEventListener('mousedown', startDrag);
                nodeEl.addEventListener('click', selectNode);
                
                canvas.appendChild(nodeEl);
            });
            
            // Render connections
            if (currentWorkflow.connections) {
                currentWorkflow.connections.forEach(connection => {
                    renderEdge(connection);
                });
            }
        }
        
        function renderEdge(edge) {
            const sourceNode = document.querySelector(`[data-node-id="${edge.sourceNodeId}"]`);
            const targetNode = document.querySelector(`[data-node-id="${edge.targetNodeId}"]`);
            
            if (!sourceNode || !targetNode) return;
            
            const sourceRect = sourceNode.getBoundingClientRect();
            const targetRect = targetNode.getBoundingClientRect();
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            
            const x1 = sourceRect.right - canvasRect.left;
            const y1 = sourceRect.top + sourceRect.height / 2 - canvasRect.top;
            const x2 = targetRect.left - canvasRect.left;
            const y2 = targetRect.top + targetRect.height / 2 - canvasRect.top;
            
            const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            
            const edgeEl = document.createElement('div');
            edgeEl.className = 'edge';
            edgeEl.style.left = x1 + 'px';
            edgeEl.style.top = y1 + 'px';
            edgeEl.style.width = length + 'px';
            edgeEl.style.transform = `rotate(${angle}deg)`;
            
            document.getElementById('canvas').appendChild(edgeEl);
        }
        
        function startDrag(e) {
            dragNode = e.currentTarget;
            const rect = dragNode.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            e.preventDefault();
        }
        
        function drag(e) {
            if (!dragNode) return;
            
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            const x = e.clientX - canvasRect.left - dragOffset.x;
            const y = e.clientY - canvasRect.top - dragOffset.y;
            
            dragNode.style.left = Math.max(0, x) + 'px';
            dragNode.style.top = Math.max(0, y) + 'px';
            
            // Update workflow data
            const nodeId = dragNode.dataset.nodeId;
            const node = currentWorkflow.nodes.find(n => n.id === nodeId);
            if (node) {
                node.position.x = Math.max(0, x);
                node.position.y = Math.max(0, y);
            }
            
            // Re-render connections
            const existingEdges = document.querySelectorAll('.edge');
            existingEdges.forEach(edge => edge.remove());
            if (currentWorkflow.connections) {
                currentWorkflow.connections.forEach(connection => renderEdge(connection));
            }
        }
        
        function stopDrag() {
            dragNode = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }
        
        function selectNode(e) {
            if (dragNode) return; // Don't select if we were dragging
            
            const nodeId = e.currentTarget.dataset.nodeId;
            selectedNode = currentWorkflow.nodes.find(n => n.id === nodeId);
            
            // Visual feedback
            document.querySelectorAll('.node').forEach(n => n.style.borderWidth = '2px');
            e.currentTarget.style.borderWidth = '4px';
            
            showNodeInfo();
        }
        
        function showWorkflowInfo() {
            if (!currentWorkflow) return;
            
            document.getElementById('workflowInfo').style.display = 'block';
            document.getElementById('workflowDetails').innerHTML = `
                <strong>Name:</strong> ${currentWorkflow.name}<br>
                <strong>ID:</strong> ${currentWorkflow.id}<br>
                <strong>Nodes:</strong> ${currentWorkflow.nodes.length}<br>
                <strong>Connections:</strong> ${currentWorkflow.connections ? currentWorkflow.connections.length : 0}
            `;
        }
        
        function showNodeInfo() {
            if (!selectedNode) return;
            
            document.getElementById('nodeInfo').style.display = 'block';
            document.getElementById('nodeDetails').innerHTML = `
                <strong>Type:</strong> ${selectedNode.type}<br>
                <strong>ID:</strong> ${selectedNode.id}<br>
                <strong>Position:</strong> (${selectedNode.position.x}, ${selectedNode.position.y})
            `;
            
            document.getElementById('nodeMessage').value = selectedNode.parameters.message || '';
        }
        
        function updateNode() {
            if (!selectedNode) return;
            
            const message = document.getElementById('nodeMessage').value;
            selectedNode.parameters.message = message;
            
            // Update visual
            const nodeEl = document.querySelector(`[data-node-id="${selectedNode.id}"]`);
            const contentEl = nodeEl.querySelector('.node-content');
            contentEl.textContent = message || selectedNode.id;
            
            showStatus('Node updated', 'success');
        }
        
        function addStartNode() {
            if (!currentWorkflow) {
                showStatus('Load or create a workflow first', 'error');
                return;
            }
            
            const newNode = {
                id: `start-${Date.now()}`,
                type: 'core.start',
                position: { x: Math.random() * 400 + 50, y: Math.random() * 300 + 50 },
                parameters: {}
            };
            
            currentWorkflow.nodes.push(newNode);
            renderWorkflow();
            showStatus('Start node added', 'success');
        }
        
        function addLogNode() {
            if (!currentWorkflow) {
                showStatus('Load or create a workflow first', 'error');
                return;
            }
            
            const newNode = {
                id: `log-${Date.now()}`,
                type: 'core.log',
                position: { x: Math.random() * 400 + 50, y: Math.random() * 300 + 50 },
                parameters: { message: 'New log message' }
            };
            
            currentWorkflow.nodes.push(newNode);
            renderWorkflow();
            showStatus('Log node added', 'success');
        }
        
        async function executeWorkflow() {
            if (!currentWorkflow) {
                showStatus('No workflow loaded', 'error');
                return;
            }
            
            showStatus('Executing workflow...', 'info');
            
            // Simple execution simulation
            let currentNodeId = null;
            
            // Find start node
            const startNode = currentWorkflow.nodes.find(n => n.type === 'core.start');
            if (!startNode) {
                showStatus('No start node found', 'error');
                return;
            }
            
            currentNodeId = startNode.id;
            let step = 0;
            
            while (currentNodeId && step < 10) {
                step++;
                const node = currentWorkflow.nodes.find(n => n.id === currentNodeId);
                if (!node) break;
                
                // Highlight current node
                document.querySelectorAll('.node').forEach(n => n.style.backgroundColor = 'white');
                const nodeEl = document.querySelector(`[data-node-id="${currentNodeId}"]`);
                if (nodeEl) nodeEl.style.backgroundColor = '#ffffcc';
                
                showStatus(`Step ${step}: Executing ${node.type}`, 'info');
                
                if (node.type === 'core.log' && node.parameters.message) {
                    console.log(`[WORKFLOW LOG] ${node.parameters.message}`);
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Find next node
                const nextConnection = currentWorkflow.connections ? 
                    currentWorkflow.connections.find(c => c.sourceNodeId === currentNodeId) : null;
                currentNodeId = nextConnection ? nextConnection.targetNodeId : null;
            }
            
            // Reset highlights
            document.querySelectorAll('.node').forEach(n => n.style.backgroundColor = 'white');
            showStatus('Workflow execution completed', 'success');
        }
        
        // Initialize
        showStatus('Workflow Editor ready. Create or load a workflow to start.', 'success');
    </script>
</body>
</html>